
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="bnode-core">
      
      
        <meta name="author" content="Julius Aka">
      
      
        <link rel="canonical" href="https://github.com/juliusaka/balanced-neural-odes/bnode_core/ode/bnode/bnode_export/">
      
      
        <link rel="prev" href="../bnode/">
      
      
        <link rel="next" href="../../node/">
      
      
        
      
      
      <link rel="icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>BNODE Export - bnode-core</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,300i,400,400i,700,700i%7CJetBrains+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Inter";--md-code-font:"JetBrains Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#bnode-export" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="bnode-core" class="md-header__button md-logo" aria-label="bnode-core" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16 0H8C6.9 0 6 .9 6 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V6zm4 18H8V2h7v5h5zM4 4v18h16v2H4c-1.1 0-2-.9-2-2V4zm6 6v2h8v-2zm0 4v2h5v-2z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            bnode-core
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              BNODE Export
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/juliusaka/balanced-neural-odes" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../../../reference/" class="md-tabs__link">
          
  
  
  API Reference

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../config/" class="md-tabs__link">
          
  
  
  Config

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../LICENSE/" class="md-tabs__link">
        
  
  
    
  
  License

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="bnode-core" class="md-nav__button md-logo" aria-label="bnode-core" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16 0H8C6.9 0 6 .9 6 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V6zm4 18H8V2h7v5h5zM4 4v18h16v2H4c-1.1 0-2-.9-2-2V4zm6 6v2h8v-2zm0 4v2h5v-2z"/></svg>

    </a>
    bnode-core
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/juliusaka/balanced-neural-odes" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    API Reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../reference/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Data Generation
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Data Generation
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../data_generation/introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Introduction
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../data_generation/raw_data_generation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Raw Data Generation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../data_generation/data_preperation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Data Preparation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" checked>
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    (B)NODE Module
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    (B)NODE Module
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../trainer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Trainer Module
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2_3_2" id="__nav_2_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    BNODE
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_3_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_3_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    BNODE
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../bnode/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    BNODE Module
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    BNODE Export
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    BNODE Export
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#bnode_core.ode.bnode.bnode_export" class="md-nav__link">
    <span class="md-ellipsis">
      
        bnode_export
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="bnode_export">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bnode_core.ode.bnode.bnode_export--warning" class="md-nav__link">
    <span class="md-ellipsis">
      
        Warning
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bnode_core.ode.bnode.bnode_export--overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        Overview
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bnode_core.ode.bnode.bnode_export--export-process" class="md-nav__link">
    <span class="md-ellipsis">
      
        Export Process
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bnode_core.ode.bnode.bnode_export--exported-artifacts" class="md-nav__link">
    <span class="md-ellipsis">
      
        Exported Artifacts
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bnode_core.ode.bnode.bnode_export--configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Configuration
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bnode_core.ode.bnode.bnode_export--dataset-requirements" class="md-nav__link">
    <span class="md-ellipsis">
      
        Dataset Requirements
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bnode_core.ode.bnode.bnode_export--typical-usage-examples" class="md-nav__link">
    <span class="md-ellipsis">
      
        Typical Usage Examples
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bnode_core.ode.bnode.bnode_export--onnx-export-backend-selection" class="md-nav__link">
    <span class="md-ellipsis">
      
        ONNX Export Backend Selection
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bnode_core.ode.bnode.bnode_export--notes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Notes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bnode_core.ode.bnode.bnode_export--see-also" class="md-nav__link">
    <span class="md-ellipsis">
      
        See Also
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bnode_core.ode.bnode.bnode_export.load_trained_latent_ode" class="md-nav__link">
    <span class="md-ellipsis">
      
        load_trained_latent_ode
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bnode_core.ode.bnode.bnode_export.export_example_io_data" class="md-nav__link">
    <span class="md-ellipsis">
      
        export_example_io_data
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bnode_core.ode.bnode.bnode_export.log_shapes_of_dict" class="md-nav__link">
    <span class="md-ellipsis">
      
        log_shapes_of_dict
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bnode_core.ode.bnode.bnode_export.export_bnode" class="md-nav__link">
    <span class="md-ellipsis">
      
        export_bnode
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../node/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    NODE
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3_4" >
        
          
          <label class="md-nav__link" for="__nav_2_3_4" id="__nav_2_3_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    ODE Utilities
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    ODE Utilities
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../trainer_utils/test_from_mlflow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Testing from MLflow checkpointed runs
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4" >
        
          
          <label class="md-nav__link" for="__nav_2_4" id="__nav_2_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Neural Networks
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Neural Networks
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../nn/nn_utils/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Neural Network Utils
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../nn/vae/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    VAE (Variational Autoencoder)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../filepaths/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Filepaths
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Configuration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Config
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Config
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Configuration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../LICENSE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    License
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#bnode_core.ode.bnode.bnode_export" class="md-nav__link">
    <span class="md-ellipsis">
      
        bnode_export
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="bnode_export">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bnode_core.ode.bnode.bnode_export--warning" class="md-nav__link">
    <span class="md-ellipsis">
      
        Warning
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bnode_core.ode.bnode.bnode_export--overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        Overview
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bnode_core.ode.bnode.bnode_export--export-process" class="md-nav__link">
    <span class="md-ellipsis">
      
        Export Process
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bnode_core.ode.bnode.bnode_export--exported-artifacts" class="md-nav__link">
    <span class="md-ellipsis">
      
        Exported Artifacts
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bnode_core.ode.bnode.bnode_export--configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Configuration
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bnode_core.ode.bnode.bnode_export--dataset-requirements" class="md-nav__link">
    <span class="md-ellipsis">
      
        Dataset Requirements
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bnode_core.ode.bnode.bnode_export--typical-usage-examples" class="md-nav__link">
    <span class="md-ellipsis">
      
        Typical Usage Examples
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bnode_core.ode.bnode.bnode_export--onnx-export-backend-selection" class="md-nav__link">
    <span class="md-ellipsis">
      
        ONNX Export Backend Selection
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bnode_core.ode.bnode.bnode_export--notes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Notes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bnode_core.ode.bnode.bnode_export--see-also" class="md-nav__link">
    <span class="md-ellipsis">
      
        See Also
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bnode_core.ode.bnode.bnode_export.load_trained_latent_ode" class="md-nav__link">
    <span class="md-ellipsis">
      
        load_trained_latent_ode
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bnode_core.ode.bnode.bnode_export.export_example_io_data" class="md-nav__link">
    <span class="md-ellipsis">
      
        export_example_io_data
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bnode_core.ode.bnode.bnode_export.log_shapes_of_dict" class="md-nav__link">
    <span class="md-ellipsis">
      
        log_shapes_of_dict
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bnode_core.ode.bnode.bnode_export.export_bnode" class="md-nav__link">
    <span class="md-ellipsis">
      
        export_bnode
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="bnode-export">BNODE Export</h1>


<div class="doc doc-object doc-module">



<h2 id="bnode_core.ode.bnode.bnode_export" class="doc doc-heading">
            <code>bnode_core.ode.bnode.bnode_export</code>


</h2>

    <div class="doc doc-contents first">

        <p>BNODE Model Export to ONNX Format.</p>
<p>This module provides functionality to export trained Balanced Neural ODE (BNODE) 
models to ONNX format for deployment in production environments. The export process 
decomposes the BNODE architecture into individual ONNX components that can be 
integrated into external inference pipelines.</p>
<h4 id="bnode_core.ode.bnode.bnode_export--warning">Warning</h4>
<p>This documentation is AI generated and may contain inaccuracies. Please verify.</p>
<h4 id="bnode_core.ode.bnode.bnode_export--overview">Overview</h4>
<p>BNODE models consist of multiple neural network components organized in a 
variational autoencoder (VAE) structure with a latent ODE:</p>
<ol>
<li>
<p><strong>Encoders</strong>: Transform high-dimensional inputs to latent representations</p>
<ul>
<li>State encoder: Maps physical states to latent state space</li>
<li>Control encoder: Maps control inputs to latent control space (optional)</li>
<li>Parameter encoder: Maps system parameters to latent parameter space (optional)</li>
</ul>
</li>
<li>
<p><strong>Latent ODE</strong>: Defines dynamics in the learned latent space</p>
<ul>
<li>Can be linear (SSM-based) or nonlinear (neural network)</li>
<li>Supports variance propagation (constant or dynamic)</li>
<li>Optionally conditioned on latent controls and parameters</li>
</ul>
</li>
<li>
<p><strong>Decoder</strong>: Reconstructs physical quantities from latent states</p>
<ul>
<li>Maps latent states back to physical state space</li>
<li>Optionally reconstructs system outputs</li>
<li>Can incorporate latent parameters and controls</li>
</ul>
</li>
</ol>
<h4 id="bnode_core.ode.bnode.bnode_export--export-process">Export Process</h4>
<p>The export workflow involves:</p>
<ol>
<li><strong>Model Loading</strong>: Retrieve trained model from MLflow or local directory</li>
<li><strong>Configuration</strong>: Load training configuration and dataset for normalization</li>
<li><strong>Component Separation</strong>: Extract individual neural network modules</li>
<li><strong>ONNX Conversion</strong>: Export each component with dynamic batch dimensions</li>
<li><strong>Example I/O</strong>: Save sample inputs/outputs in HDF5 for validation</li>
</ol>
<h4 id="bnode_core.ode.bnode.bnode_export--exported-artifacts">Exported Artifacts</h4>
<p>For each BNODE model, the following files are generated:</p>
<ul>
<li><code>encoder_states.onnx</code>: State encoder neural network</li>
<li><code>encoder_controls.onnx</code>: Control encoder (if applicable)</li>
<li><code>encoder_parameters.onnx</code>: Parameter encoder (if applicable)</li>
<li><code>latent_ode.onnx</code>: Latent ODE function</li>
<li><code>latent_ode_ssm_from_param.onnx</code>: SSM parameter mapping (linear models only)</li>
<li><code>decoder.onnx</code>: Decoder neural network</li>
<li><code>*_example_io.hdf5</code>: Example input/output data for each component</li>
<li><code>bnode_config.yaml</code>: Complete model configuration</li>
</ul>
<h4 id="bnode_core.ode.bnode.bnode_export--configuration">Configuration</h4>
<p>The export process is configured using Hydra with the <code>onnx_export_config_class</code> 
dataclass. Configuration can be provided via:</p>
<ol>
<li>YAML config file (<code>conf/onnx_export.yaml</code>)</li>
<li>Command-line overrides</li>
<li>Programmatic instantiation</li>
</ol>


<details class="required-configuration-fields" open>
  <summary>Required Configuration Fields</summary>
  <p>Either <code>mlflow_run_id</code> OR <code>model_directory</code> must be specified:</p>
<ul>
<li><strong>mlflow_run_id</strong> (str): MLflow run ID to retrieve model from tracking server</li>
<li><strong>model_directory</strong> (str): Local path to model artifacts directory</li>
</ul>
</details>

<details class="optional-configuration-fields" open>
  <summary>Optional Configuration Fields</summary>
  <ul>
<li><strong>mlflow_tracking_uri</strong> (str): MLflow server URI (default: local <code>./mlruns</code>)</li>
<li><strong>model_checkpoint_path</strong> (str): Specific checkpoint file (default: latest)</li>
<li><strong>config_path</strong> (str): Custom config file (default: <code>.hydra/config_validated.yaml</code>)</li>
<li><strong>dataset_path</strong> (str): Dataset for normalization (default: <code>dataset.hdf5</code>)</li>
<li><strong>output_dir</strong> (str): Export destination (default: Hydra output directory)</li>
</ul>
</details>        <h4 id="bnode_core.ode.bnode.bnode_export--dataset-requirements">Dataset Requirements</h4>
<p>A dataset in HDF5 format is required for model initialization and normalization. 
The dataset must contain:</p>
<ul>
<li><strong>Structure</strong>: Training/validation/test splits with trajectories</li>
<li><strong>Variables</strong>: States, controls, parameters, outputs (as applicable)</li>
<li><strong>Format</strong>: Shape <code>(n_trajectories, n_variables, n_timesteps)</code></li>
<li><strong>Source</strong>: Generated by <code>data_generation</code> module or provided externally</li>
</ul>
<p>The dataset is used to:
1. Initialize model dimensions and normalization layers
2. Provide example inputs for ONNX graph tracing
3. Validate exported models against known data</p>
<h4 id="bnode_core.ode.bnode.bnode_export--typical-usage-examples">Typical Usage Examples</h4>
<p><strong>Example 1: Export from MLflow Run</strong>::</p>
<div class="highlight"><pre><span></span><code># Export model from MLflow tracking server
uv run bnode_export mlflow_run_id=abc123def456 \
                    mlflow_tracking_uri=http://localhost:5000 \
                    output_dir=./exports/my_model
</code></pre></div>
<p><strong>Example 2: Export from Local Directory</strong>::</p>
<div class="highlight"><pre><span></span><code># Export model from local artifacts
uv run bnode_export model_directory=./outputs/2024-11-07/10-30-45 \
                    output_dir=./exports/my_model
</code></pre></div>
<p><strong>Example 3: Custom Checkpoint and Dataset</strong>::</p>
<div class="highlight"><pre><span></span><code># Specify custom checkpoint and dataset paths
uv run bnode_export mlflow_run_id=abc123def456 \
                    model_checkpoint_path=./checkpoints/model_phase_3.pt \
                    dataset_path=./data/custom_dataset.hdf5 \
                    output_dir=./exports/custom_export
</code></pre></div>
<p><strong>Example 4: Export with Hydra Multirun</strong>::</p>
<div class="highlight"><pre><span></span><code># Export multiple models in parallel
uv run bnode_export --multirun \
                    mlflow_run_id=run1,run2,run3 \
                    output_dir=./exports
</code></pre></div>
<h4 id="bnode_core.ode.bnode.bnode_export--onnx-export-backend-selection">ONNX Export Backend Selection</h4>
<p>This module uses PyTorch's ONNX export with <code>dynamo=False</code> to leverage the 
legacy TorchScript-based exporter. This choice is made for the following reasons:</p>
<p><strong>Why Legacy Exporter (dynamo=False)?</strong></p>
<ol>
<li>
<p><strong>Stability</strong>: The TorchScript-based exporter is mature and battle-tested with 
   complex neural network architectures including custom layers and control flow.</p>
</li>
<li>
<p><strong>Complex Model Support</strong>: BNODE models contain:</p>
</li>
<li>
<p>Conditional logic (variance modes, parameter inclusion)</p>
</li>
<li>Custom normalization layers with stateful initialization</li>
<li>Multiple encoder/decoder components with optional inputs</li>
<li>Dynamic control flow based on model configuration</li>
</ol>
<p>The legacy exporter handles these patterns more reliably.</p>
<ol>
<li><strong>Keyword Arguments</strong>: Models with optional keyword arguments (like latent 
   parameters and controls) require the <code>kwargs</code> parameter, which works 
   seamlessly with the legacy exporter.</li>
</ol>
<p><strong>About the New Exporter (dynamo=True)</strong></p>
<p>Starting in PyTorch 2.9, <code>dynamo=True</code> is the default, using the new 
<code>torch.export</code>-based exporter with ONNXScript. This provides:</p>
<ul>
<li>Better support for dynamic shapes and LLMs</li>
<li>More modern export pipeline</li>
<li>Enhanced control flow handling</li>
</ul>
<p>However, it may encounter issues with:</p>
<ul>
<li>Complex conditional logic</li>
<li>Custom layer implementations</li>
<li>Stateful modules (like normalization with deferred initialization)</li>
</ul>
<p><strong>Migration Path</strong></p>
<p>If you wish to try the new exporter:</p>
<ol>
<li>Change <code>dynamo=False</code> to <code>dynamo=True</code> in all <code>torch.onnx.export</code> calls</li>
<li>Test thoroughly with your specific model configurations</li>
<li>Address any tracing warnings or errors</li>
<li>Validate exported ONNX models match PyTorch reference outputs</li>
</ol>
<p>The legacy exporter will remain supported for the foreseeable future, so there's 
no immediate need to migrate unless you require new exporter-specific features.</p>
<p><strong>Deprecation Warnings</strong></p>
<p>You may see deprecation warnings when using <code>dynamo=False</code>. These are 
informational and do not affect functionality. The warnings encourage trying 
the new exporter but the legacy path remains fully supported.</p>
<h4 id="bnode_core.ode.bnode.bnode_export--notes">Notes</h4>
<ul>
<li>All exported ONNX models use dynamic batch dimensions for flexible inference</li>
<li>Models are exported in evaluation mode (dropout/batch norm frozen)</li>
<li>Normalization parameters are embedded in the exported models</li>
<li>Linear latent ODEs export separate SSM parameter mapping for efficiency</li>
<li>Export uses <code>kwargs</code> parameter to handle optional model inputs correctly</li>
</ul>
<h4 id="bnode_core.ode.bnode.bnode_export--see-also">See Also</h4>
<ul>
<li><code>bnode_core.ode.trainer</code> : Training pipeline for BNODE models</li>
<li><code>bnode_core.config.onnx_export_config_class</code> : Configuration dataclass</li>
<li><code>bnode_core.ode.bnode</code> : BNODE model architecture definitions</li>
</ul>










<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="bnode_core.ode.bnode.bnode_export.load_trained_latent_ode" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_trained_latent_ode</span><span class="p">(</span><span class="n">cfg_export</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Load a trained BNODE model from MLflow or local directory.</p>
<p>This function retrieves a trained BNODE model and its associated artifacts
(configuration, dataset, checkpoint) from either an MLflow tracking server
or a local directory. It reconstructs the model architecture and loads the
trained weights.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>cfg_export</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="onnx_export_config_class (bnode_core.config.onnx_export_config_class)" href="../../../config/#bnode_core.config.onnx_export_config_class">onnx_export_config_class</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Export configuration containing:</p>
<ul>
<li>mlflow_run_id: MLflow run identifier (if loading from MLflow)</li>
<li>model_directory: Local directory path (if loading locally)</li>
<li>mlflow_tracking_uri: MLflow tracking server URI</li>
<li>config_path: Optional custom configuration path</li>
<li>dataset_path: Optional custom dataset path</li>
<li>model_checkpoint_path: Optional specific checkpoint file</li>
</ul>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing:</p>
<ul>
<li>'model': Initialized BNODE model with loaded weights</li>
<li>'cfg': OmegaConf configuration object</li>
<li>'dataset_file': Opened HDF5 dataset file handle</li>
<li>'dataset': Processed training dataset (stacked format)</li>
<li>'temp_dir': Temporary directory path (if artifacts were downloaded, None otherwise)</li>
</ul>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="FileNotFoundError">FileNotFoundError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If dataset file cannot be found at specified path.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li>CUDA is disabled (use_cuda=False) for CPU-based ONNX export</li>
<li>Normalization is not re-initialized (uses saved parameters)</li>
<li>Latest checkpoint is used if model_checkpoint_path is None</li>
<li>Model is loaded in evaluation mode for deterministic inference</li>
<li>When loading from MLflow remote server, artifacts are downloaded to Hydra output folder</li>
<li>Temporary artifact directory is named 'mlflow_artifacts_{run_id}' in Hydra output</li>
</ul>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/bnode_core/ode/bnode/bnode_export.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-216" name="__codelineno-0-216"></a><span class="k">def</span><span class="w"> </span><span class="nf">load_trained_latent_ode</span><span class="p">(</span><span class="n">cfg_export</span><span class="p">):</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Load a trained BNODE model from MLflow or local directory.</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a><span class="sd">    This function retrieves a trained BNODE model and its associated artifacts</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a><span class="sd">    (configuration, dataset, checkpoint) from either an MLflow tracking server</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a><span class="sd">    or a local directory. It reconstructs the model architecture and loads the</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a><span class="sd">    trained weights.</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a><span class="sd">        cfg_export (onnx_export_config_class): Export configuration containing:</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a><span class="sd">            - mlflow_run_id: MLflow run identifier (if loading from MLflow)</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a><span class="sd">            - model_directory: Local directory path (if loading locally)</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a><span class="sd">            - mlflow_tracking_uri: MLflow tracking server URI</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a><span class="sd">            - config_path: Optional custom configuration path</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a><span class="sd">            - dataset_path: Optional custom dataset path</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a><span class="sd">            - model_checkpoint_path: Optional specific checkpoint file</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a><span class="sd">        dict (dict): Dictionary containing:</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a><span class="sd">            - &#39;model&#39;: Initialized BNODE model with loaded weights</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a><span class="sd">            - &#39;cfg&#39;: OmegaConf configuration object</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a><span class="sd">            - &#39;dataset_file&#39;: Opened HDF5 dataset file handle</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a><span class="sd">            - &#39;dataset&#39;: Processed training dataset (stacked format)</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a><span class="sd">            - &#39;temp_dir&#39;: Temporary directory path (if artifacts were downloaded, None otherwise)</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a><span class="sd">        FileNotFoundError: If dataset file cannot be found at specified path.</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a><span class="sd">    Notes:</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a><span class="sd">        - CUDA is disabled (use_cuda=False) for CPU-based ONNX export</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a><span class="sd">        - Normalization is not re-initialized (uses saved parameters)</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a><span class="sd">        - Latest checkpoint is used if model_checkpoint_path is None</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a><span class="sd">        - Model is loaded in evaluation mode for deterministic inference</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a><span class="sd">        - When loading from MLflow remote server, artifacts are downloaded to Hydra output folder</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a><span class="sd">        - Temporary artifact directory is named &#39;mlflow_artifacts_{run_id}&#39; in Hydra output</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>    <span class="n">temp_dir</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>    <span class="c1"># get artifacts directory</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>    <span class="k">if</span> <span class="n">cfg_export</span><span class="o">.</span><span class="n">mlflow_run_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>        <span class="n">mlflow</span><span class="o">.</span><span class="n">set_tracking_uri</span><span class="p">(</span><span class="n">cfg_export</span><span class="o">.</span><span class="n">mlflow_tracking_uri</span><span class="p">)</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>        <span class="n">mlflow_run</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">get_run</span><span class="p">(</span><span class="n">cfg_export</span><span class="o">.</span><span class="n">mlflow_run_id</span><span class="p">)</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>        <span class="n">artifact_uri</span> <span class="o">=</span> <span class="n">mlflow_run</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">artifact_uri</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>        <span class="c1"># Check if artifacts are on remote server (not local file://)</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">artifact_uri</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;file://&#39;</span><span class="p">):</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>            <span class="c1"># Download artifacts to temporary directory in Hydra output folder</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>            <span class="n">hydra_output_dir</span> <span class="o">=</span> <span class="n">filepaths</span><span class="o">.</span><span class="n">dir_current_hydra_output</span><span class="p">()</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>            <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">hydra_output_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;mlflow_artifacts_</span><span class="si">{</span><span class="n">cfg_export</span><span class="o">.</span><span class="n">mlflow_run_id</span><span class="si">}</span><span class="s1">&#39;</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>            <span class="n">temp_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Downloading MLflow artifacts from remote server to: </span><span class="si">{</span><span class="n">temp_dir</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>            <span class="c1"># Download all artifacts</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>            <span class="n">mlflow</span><span class="o">.</span><span class="n">artifacts</span><span class="o">.</span><span class="n">download_artifacts</span><span class="p">(</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>                <span class="n">run_id</span><span class="o">=</span><span class="n">cfg_export</span><span class="o">.</span><span class="n">mlflow_run_id</span><span class="p">,</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>                <span class="n">dst_path</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">)</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>            <span class="p">)</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>            <span class="n">dir_artifacts</span> <span class="o">=</span> <span class="n">temp_dir</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Successfully downloaded artifacts to </span><span class="si">{</span><span class="n">temp_dir</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>            <span class="c1"># Local MLflow artifacts</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>            <span class="n">dir_artifacts</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">artifact_uri</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;file://&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>        <span class="n">dir_artifacts</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">cfg_export</span><span class="o">.</span><span class="n">model_directory</span><span class="p">)</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Resolved artifacts uri as </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dir_artifacts</span><span class="p">)))</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>    <span class="c1"># get config and dataset paths</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>    <span class="k">if</span> <span class="n">cfg_export</span><span class="o">.</span><span class="n">config_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>        <span class="n">path_config</span> <span class="o">=</span> <span class="n">dir_artifacts</span> <span class="o">/</span> <span class="s1">&#39;.hydra&#39;</span> <span class="o">/</span> <span class="s1">&#39;config_validated.yaml&#39;</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>    <span class="k">else</span><span class="p">:</span> 
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Custom config_path is not supported in this version.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>    <span class="c1"># dataset path</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>    <span class="k">if</span> <span class="n">cfg_export</span><span class="o">.</span><span class="n">dataset_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>        <span class="n">path_dataset</span> <span class="o">=</span> <span class="n">dir_artifacts</span> <span class="o">/</span> <span class="s1">&#39;dataset.hdf5&#39;</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>        <span class="k">if</span> <span class="n">cfg_export</span><span class="o">.</span><span class="n">dataset_path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;file://&#39;</span><span class="p">):</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>            <span class="n">path_dataset</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">cfg_export</span><span class="o">.</span><span class="n">dataset_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;file://&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>            <span class="n">path_dataset</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">cfg_export</span><span class="o">.</span><span class="n">dataset_path</span><span class="p">)</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>    <span class="c1"># load config (and validate it using the dataclass?)</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_config</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>        <span class="n">cfg_dict</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">FullLoader</span><span class="p">)</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>        <span class="n">cfg</span> <span class="o">=</span> <span class="n">OmegaConf</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">cfg_dict</span><span class="p">)</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>        <span class="n">cfg</span><span class="o">.</span><span class="n">use_cuda</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Loaded config of BNODE: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">)))</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>    <span class="c1"># load training dataset</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>    <span class="k">if</span> <span class="n">path_dataset</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>        <span class="n">dataset_file</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">path_dataset</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Dataset file </span><span class="si">{</span><span class="n">path_dataset</span><span class="si">}</span><span class="s1"> not found. Please provide a valid dataset path.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>    <span class="n">dataset</span> <span class="o">=</span> <span class="n">make_stacked_dataset</span><span class="p">(</span><span class="n">dataset_file</span><span class="p">,</span> <span class="s1">&#39;train&#39;</span><span class="p">)</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">initialize_model</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">train_dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span> <span class="n">hdf5_dataset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>                             <span class="n">initialize_normalization</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">model_type</span><span class="o">=</span><span class="s1">&#39;bnode&#39;</span><span class="p">)</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>    <span class="c1"># load latest checkpoint</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>    <span class="k">if</span> <span class="n">cfg_export</span><span class="o">.</span><span class="n">model_checkpoint_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>        <span class="n">path_checkpoint</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">dir_artifacts</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s1">&#39;model_phase_*.pt&#39;</span><span class="p">))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>        <span class="k">if</span> <span class="n">cfg_export</span><span class="o">.</span><span class="n">model_checkpoint_path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;file://&#39;</span><span class="p">):</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>            <span class="n">path_checkpoint</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">cfg_export</span><span class="o">.</span><span class="n">model_checkpoint_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;file://&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>            <span class="n">path_checkpoint</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">cfg_export</span><span class="o">.</span><span class="n">model_checkpoint_path</span><span class="p">)</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">path_checkpoint</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Checkpoint file </span><span class="si">{</span><span class="n">path_checkpoint</span><span class="si">}</span><span class="s1"> not found. Please provide a valid checkpoint path.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>    <span class="n">model</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path_checkpoint</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span> <span class="s1">&#39;cfg&#39;</span><span class="p">:</span> <span class="n">cfg</span><span class="p">,</span> <span class="s1">&#39;dataset_file&#39;</span><span class="p">:</span> <span class="n">dataset_file</span><span class="p">,</span> <span class="s1">&#39;dataset&#39;</span><span class="p">:</span> <span class="n">dataset</span><span class="p">,</span> <span class="s1">&#39;temp_dir&#39;</span><span class="p">:</span> <span class="n">temp_dir</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="bnode_core.ode.bnode.bnode_export.export_example_io_data" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">export_example_io_data</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">path_example_io</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Export example input/output data for ONNX model validation.</p>
<p>Saves the inputs and outputs of a model component to an HDF5 file for
later validation. This allows users to verify that their ONNX runtime
produces identical results to the PyTorch reference implementation.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>res</code>
            </td>
            <td>
                  <code>different types</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Model output(s). Can be:
- torch.Tensor: Single output tensor
- tuple/list: Multiple output tensors
- dict: Named output tensors</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>inputs</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary of input tensors with their names as keys.
Each value can be a torch.Tensor or None.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>path_example_io</code>
            </td>
            <td>
                  <code><span title="pathlib.Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Output path for the HDF5 file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<details class="hdf5-structure" open>
  <summary>HDF5 Structure</summary>
  <p>/inputs/
    <input_name_1>: dataset (array)
    <input_name_2>: dataset (array)
    ...
/outputs/
    output: dataset (single output case)
    OR
    output_0, output_1, ...: datasets (multiple output case)
    OR
    <output_name_1>, <output_name_2>, ...: datasets (dict output case)</p>
</details>

<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li>Tensors are automatically converted to NumPy arrays</li>
<li>None inputs are skipped</li>
<li>Outputs are organized based on their type (tensor/tuple/dict)</li>
</ul>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/bnode_core/ode/bnode/bnode_export.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-332" name="__codelineno-0-332"></a><span class="k">def</span><span class="w"> </span><span class="nf">export_example_io_data</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">path_example_io</span><span class="p">):</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Export example input/output data for ONNX model validation.</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a><span class="sd">    Saves the inputs and outputs of a model component to an HDF5 file for</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a><span class="sd">    later validation. This allows users to verify that their ONNX runtime</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a><span class="sd">    produces identical results to the PyTorch reference implementation.</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a><span class="sd">        res (different types): Model output(s). Can be:</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a><span class="sd">            - torch.Tensor: Single output tensor</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a><span class="sd">            - tuple/list: Multiple output tensors</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a><span class="sd">            - dict: Named output tensors</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a><span class="sd">        inputs (dict): Dictionary of input tensors with their names as keys.</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a><span class="sd">            Each value can be a torch.Tensor or None.</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a><span class="sd">        path_example_io (Path): Output path for the HDF5 file.</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a><span class="sd">    HDF5 Structure:</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a><span class="sd">        /inputs/</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a><span class="sd">            &lt;input_name_1&gt;: dataset (array)</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a><span class="sd">            &lt;input_name_2&gt;: dataset (array)</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a><span class="sd">            ...</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a><span class="sd">        /outputs/</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a><span class="sd">            output: dataset (single output case)</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a><span class="sd">            OR</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a><span class="sd">            output_0, output_1, ...: datasets (multiple output case)</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a><span class="sd">            OR</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a><span class="sd">            &lt;output_name_1&gt;, &lt;output_name_2&gt;, ...: datasets (dict output case)</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a><span class="sd">    Notes:</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a><span class="sd">        - Tensors are automatically converted to NumPy arrays</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a><span class="sd">        - None inputs are skipped</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a><span class="sd">        - Outputs are organized based on their type (tensor/tuple/dict)</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>    <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">path_example_io</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>        <span class="c1"># Save inputs</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>        <span class="n">grp_in</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;inputs&#39;</span><span class="p">)</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>        <span class="k">for</span> <span class="n">in_key</span><span class="p">,</span> <span class="n">in_val</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">in_val</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>                <span class="n">grp_in</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">in_key</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">in_val</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>            <span class="k">elif</span> <span class="n">in_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>                <span class="n">grp_in</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">in_key</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">in_val</span><span class="p">)</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>        <span class="c1"># Save outputs</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>        <span class="n">grp_out</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;outputs&#39;</span><span class="p">)</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>            <span class="n">grp_out</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">out_val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>                <span class="n">grp_out</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;output_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">out_val</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>            <span class="k">for</span> <span class="n">out_key</span><span class="p">,</span> <span class="n">out_val</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>                <span class="n">grp_out</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">out_key</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">out_val</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="bnode_core.ode.bnode.bnode_export.log_shapes_of_dict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">log_shapes_of_dict</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Log the shapes of tensors in a data structure for debugging.</p>
<p>Recursively traverses dictionaries, lists, or tuples and logs the shapes
of any PyTorch tensors found. Useful for debugging model I/O during export.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/bnode_core/ode/bnode/bnode_export.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-385" name="__codelineno-0-385"></a><span class="k">def</span><span class="w"> </span><span class="nf">log_shapes_of_dict</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Log the shapes of tensors in a data structure for debugging.</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a><span class="sd">    Recursively traverses dictionaries, lists, or tuples and logs the shapes</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a><span class="sd">    of any PyTorch tensors found. Useful for debugging model I/O during export.</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>    <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shapes in </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Shapes in .... :&quot;</span><span class="p">)</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">]: </span><span class="si">{</span><span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">]: </span><span class="si">{</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">]: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="bnode_core.ode.bnode.bnode_export.export_bnode" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">export_bnode</span><span class="p">(</span><span class="n">cfg_export</span><span class="p">:</span> <span class="n">onnx_export_config_class</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Main function for BNODE model export to ONNX format.</p>
<p>This function orchestrates the complete export process:</p>
<ol>
<li>Loads trained BNODE model and configuration</li>
<li>Extracts individual encoder, decoder, and ODE components</li>
<li>Exports each component to ONNX format with dynamic batch dimensions</li>
<li>Saves example input/output data for validation</li>
<li>Exports configuration file for reference</li>
</ol>
<p>The function is designed to be invoked via the <code>uv run bnode_export</code> command,
which is registered in <code>pyproject.toml</code>. Hydra manages configuration loading
and command-line argument parsing.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>cfg_export</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="onnx_export_config_class (bnode_core.config.onnx_export_config_class)" href="../../../config/#bnode_core.config.onnx_export_config_class">onnx_export_config_class</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Export configuration managed by Hydra.
Configuration can be specified via YAML files or command-line overrides.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<details class="export-workflow" open>
  <summary>Export Workflow</summary>
  <ol>
<li>
<p><strong>Model Loading</strong>: </p>
<ul>
<li>Retrieves model from MLflow or local directory</li>
<li>Loads configuration and dataset for normalization</li>
<li>Restores trained weights from checkpoint</li>
</ul>
</li>
<li>
<p><strong>Component Extraction</strong>:</p>
<ul>
<li>State encoder (always present)</li>
<li>Control encoder (if model uses controls)</li>
<li>Parameter encoder (if model uses parameters)</li>
<li>Latent ODE function</li>
<li>SSM parameter mapping (linear models only)</li>
<li>Decoder (states and/or outputs)</li>
</ul>
</li>
<li>
<p><strong>ONNX Export</strong>:</p>
<ul>
<li>Each component is exported separately</li>
<li>Dynamic batch dimensions allow flexible inference</li>
<li>Input/output names are explicitly defined</li>
<li>Example I/O saved for each component</li>
</ul>
</li>
<li>
<p><strong>Artifact Organization</strong>:</p>
<ul>
<li>All exports saved to output_dir or Hydra output</li>
<li>Configuration exported as <code>bnode_config.yaml</code></li>
<li>Example data in <code>*_example_io.hdf5</code> files</li>
</ul>
</li>
</ol>
</details>

<details class="command-line-usage" open>
  <summary>Command-Line Usage</summary>
  <p>Export from MLflow::</p>
<div class="highlight"><pre><span></span><code>uv run bnode_export mlflow_run_id=&lt;run_id&gt; \
                    mlflow_tracking_uri=&lt;uri&gt; \
                    output_dir=&lt;output_path&gt;
</code></pre></div>
<p>Export from local directory::</p>
<div class="highlight"><pre><span></span><code>uv run bnode_export model_directory=&lt;path&gt; \
                    output_dir=&lt;output_path&gt;
</code></pre></div>
<p>With custom checkpoint::</p>
<div class="highlight"><pre><span></span><code>uv run bnode_export mlflow_run_id=&lt;run_id&gt; \
                    model_checkpoint_path=&lt;checkpoint.pt&gt; \
                    dataset_path=&lt;dataset.hdf5&gt;
</code></pre></div>
</details>

<details class="exported-files" open>
  <summary>Exported Files</summary>
  <ul>
<li><code>encoder_states.onnx</code>: State encoder</li>
<li><code>encoder_controls.onnx</code>: Control encoder (if applicable)</li>
<li><code>encoder_parameters.onnx</code>: Parameter encoder (if applicable)</li>
<li><code>latent_ode.onnx</code>: Latent dynamics function</li>
<li><code>latent_ode_ssm_from_param.onnx</code>: SSM mapping (linear models)</li>
<li><code>decoder.onnx</code>: Decoder network</li>
<li><code>encoder_*_example_io.hdf5</code>: Example encoder I/O</li>
<li><code>latent_ode_example_io.hdf5</code>: Example ODE I/O</li>
<li><code>decoder_example_io.hdf5</code>: Example decoder I/O</li>
<li><code>bnode_config.yaml</code>: Complete model configuration</li>
</ul>
</details>

<details class="onnx-model-specifications" open>
  <summary>ONNX Model Specifications</summary>
  <p>All exported models include:</p>
<ul>
<li><strong>Dynamic axes</strong>: Batch dimension (axis 0) is dynamic</li>
<li><strong>Input names</strong>: Descriptive names for each input tensor</li>
<li><strong>Output names</strong>: Descriptive names for each output tensor</li>
</ul>
<p>Encoder outputs:</p>
<ul>
<li><code>latent_&lt;type&gt;_mu</code>: Mean of latent distribution</li>
<li><code>latent_&lt;type&gt;_logvar</code>: Log-variance of latent distribution</li>
</ul>
<p>ODE outputs:</p>
<ul>
<li><code>lat_states_mu_dot</code>: State derivative (constant variance)</li>
<li><code>concat(lat_states_mu_dot,lat_states_logvar_dot)</code>: Combined
    derivatives (dynamic variance)</li>
</ul>
<p>Decoder outputs:</p>
<ul>
<li><code>states</code>: Reconstructed physical states</li>
<li><code>outputs</code>: Reconstructed system outputs (if applicable)</li>
</ul>
</details>

<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li>Model is set to evaluation mode before export</li>
<li>All computations performed on CPU (use_cuda=False)</li>
<li>Normalization parameters are embedded in exported models</li>
<li>Example I/O files can be used to validate ONNX Runtime inference</li>
<li>Hydra output directory is used if output_dir not specified</li>
</ul>
</details>

<details class="see-also" open>
  <summary>See Also</summary>
  <ul>
<li><code>load_trained_latent_ode</code>: Model loading function</li>
<li><code>export_example_io_data</code>: Example I/O export function</li>
<li><code>bnode_core.ode.trainer.initialize_model</code>: Model initialization</li>
</ul>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/bnode_core/ode/bnode/bnode_export.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span>
<span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span>
<span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span>
<span class="normal"><a href="#__codelineno-0-473">473</a></span>
<span class="normal"><a href="#__codelineno-0-474">474</a></span>
<span class="normal"><a href="#__codelineno-0-475">475</a></span>
<span class="normal"><a href="#__codelineno-0-476">476</a></span>
<span class="normal"><a href="#__codelineno-0-477">477</a></span>
<span class="normal"><a href="#__codelineno-0-478">478</a></span>
<span class="normal"><a href="#__codelineno-0-479">479</a></span>
<span class="normal"><a href="#__codelineno-0-480">480</a></span>
<span class="normal"><a href="#__codelineno-0-481">481</a></span>
<span class="normal"><a href="#__codelineno-0-482">482</a></span>
<span class="normal"><a href="#__codelineno-0-483">483</a></span>
<span class="normal"><a href="#__codelineno-0-484">484</a></span>
<span class="normal"><a href="#__codelineno-0-485">485</a></span>
<span class="normal"><a href="#__codelineno-0-486">486</a></span>
<span class="normal"><a href="#__codelineno-0-487">487</a></span>
<span class="normal"><a href="#__codelineno-0-488">488</a></span>
<span class="normal"><a href="#__codelineno-0-489">489</a></span>
<span class="normal"><a href="#__codelineno-0-490">490</a></span>
<span class="normal"><a href="#__codelineno-0-491">491</a></span>
<span class="normal"><a href="#__codelineno-0-492">492</a></span>
<span class="normal"><a href="#__codelineno-0-493">493</a></span>
<span class="normal"><a href="#__codelineno-0-494">494</a></span>
<span class="normal"><a href="#__codelineno-0-495">495</a></span>
<span class="normal"><a href="#__codelineno-0-496">496</a></span>
<span class="normal"><a href="#__codelineno-0-497">497</a></span>
<span class="normal"><a href="#__codelineno-0-498">498</a></span>
<span class="normal"><a href="#__codelineno-0-499">499</a></span>
<span class="normal"><a href="#__codelineno-0-500">500</a></span>
<span class="normal"><a href="#__codelineno-0-501">501</a></span>
<span class="normal"><a href="#__codelineno-0-502">502</a></span>
<span class="normal"><a href="#__codelineno-0-503">503</a></span>
<span class="normal"><a href="#__codelineno-0-504">504</a></span>
<span class="normal"><a href="#__codelineno-0-505">505</a></span>
<span class="normal"><a href="#__codelineno-0-506">506</a></span>
<span class="normal"><a href="#__codelineno-0-507">507</a></span>
<span class="normal"><a href="#__codelineno-0-508">508</a></span>
<span class="normal"><a href="#__codelineno-0-509">509</a></span>
<span class="normal"><a href="#__codelineno-0-510">510</a></span>
<span class="normal"><a href="#__codelineno-0-511">511</a></span>
<span class="normal"><a href="#__codelineno-0-512">512</a></span>
<span class="normal"><a href="#__codelineno-0-513">513</a></span>
<span class="normal"><a href="#__codelineno-0-514">514</a></span>
<span class="normal"><a href="#__codelineno-0-515">515</a></span>
<span class="normal"><a href="#__codelineno-0-516">516</a></span>
<span class="normal"><a href="#__codelineno-0-517">517</a></span>
<span class="normal"><a href="#__codelineno-0-518">518</a></span>
<span class="normal"><a href="#__codelineno-0-519">519</a></span>
<span class="normal"><a href="#__codelineno-0-520">520</a></span>
<span class="normal"><a href="#__codelineno-0-521">521</a></span>
<span class="normal"><a href="#__codelineno-0-522">522</a></span>
<span class="normal"><a href="#__codelineno-0-523">523</a></span>
<span class="normal"><a href="#__codelineno-0-524">524</a></span>
<span class="normal"><a href="#__codelineno-0-525">525</a></span>
<span class="normal"><a href="#__codelineno-0-526">526</a></span>
<span class="normal"><a href="#__codelineno-0-527">527</a></span>
<span class="normal"><a href="#__codelineno-0-528">528</a></span>
<span class="normal"><a href="#__codelineno-0-529">529</a></span>
<span class="normal"><a href="#__codelineno-0-530">530</a></span>
<span class="normal"><a href="#__codelineno-0-531">531</a></span>
<span class="normal"><a href="#__codelineno-0-532">532</a></span>
<span class="normal"><a href="#__codelineno-0-533">533</a></span>
<span class="normal"><a href="#__codelineno-0-534">534</a></span>
<span class="normal"><a href="#__codelineno-0-535">535</a></span>
<span class="normal"><a href="#__codelineno-0-536">536</a></span>
<span class="normal"><a href="#__codelineno-0-537">537</a></span>
<span class="normal"><a href="#__codelineno-0-538">538</a></span>
<span class="normal"><a href="#__codelineno-0-539">539</a></span>
<span class="normal"><a href="#__codelineno-0-540">540</a></span>
<span class="normal"><a href="#__codelineno-0-541">541</a></span>
<span class="normal"><a href="#__codelineno-0-542">542</a></span>
<span class="normal"><a href="#__codelineno-0-543">543</a></span>
<span class="normal"><a href="#__codelineno-0-544">544</a></span>
<span class="normal"><a href="#__codelineno-0-545">545</a></span>
<span class="normal"><a href="#__codelineno-0-546">546</a></span>
<span class="normal"><a href="#__codelineno-0-547">547</a></span>
<span class="normal"><a href="#__codelineno-0-548">548</a></span>
<span class="normal"><a href="#__codelineno-0-549">549</a></span>
<span class="normal"><a href="#__codelineno-0-550">550</a></span>
<span class="normal"><a href="#__codelineno-0-551">551</a></span>
<span class="normal"><a href="#__codelineno-0-552">552</a></span>
<span class="normal"><a href="#__codelineno-0-553">553</a></span>
<span class="normal"><a href="#__codelineno-0-554">554</a></span>
<span class="normal"><a href="#__codelineno-0-555">555</a></span>
<span class="normal"><a href="#__codelineno-0-556">556</a></span>
<span class="normal"><a href="#__codelineno-0-557">557</a></span>
<span class="normal"><a href="#__codelineno-0-558">558</a></span>
<span class="normal"><a href="#__codelineno-0-559">559</a></span>
<span class="normal"><a href="#__codelineno-0-560">560</a></span>
<span class="normal"><a href="#__codelineno-0-561">561</a></span>
<span class="normal"><a href="#__codelineno-0-562">562</a></span>
<span class="normal"><a href="#__codelineno-0-563">563</a></span>
<span class="normal"><a href="#__codelineno-0-564">564</a></span>
<span class="normal"><a href="#__codelineno-0-565">565</a></span>
<span class="normal"><a href="#__codelineno-0-566">566</a></span>
<span class="normal"><a href="#__codelineno-0-567">567</a></span>
<span class="normal"><a href="#__codelineno-0-568">568</a></span>
<span class="normal"><a href="#__codelineno-0-569">569</a></span>
<span class="normal"><a href="#__codelineno-0-570">570</a></span>
<span class="normal"><a href="#__codelineno-0-571">571</a></span>
<span class="normal"><a href="#__codelineno-0-572">572</a></span>
<span class="normal"><a href="#__codelineno-0-573">573</a></span>
<span class="normal"><a href="#__codelineno-0-574">574</a></span>
<span class="normal"><a href="#__codelineno-0-575">575</a></span>
<span class="normal"><a href="#__codelineno-0-576">576</a></span>
<span class="normal"><a href="#__codelineno-0-577">577</a></span>
<span class="normal"><a href="#__codelineno-0-578">578</a></span>
<span class="normal"><a href="#__codelineno-0-579">579</a></span>
<span class="normal"><a href="#__codelineno-0-580">580</a></span>
<span class="normal"><a href="#__codelineno-0-581">581</a></span>
<span class="normal"><a href="#__codelineno-0-582">582</a></span>
<span class="normal"><a href="#__codelineno-0-583">583</a></span>
<span class="normal"><a href="#__codelineno-0-584">584</a></span>
<span class="normal"><a href="#__codelineno-0-585">585</a></span>
<span class="normal"><a href="#__codelineno-0-586">586</a></span>
<span class="normal"><a href="#__codelineno-0-587">587</a></span>
<span class="normal"><a href="#__codelineno-0-588">588</a></span>
<span class="normal"><a href="#__codelineno-0-589">589</a></span>
<span class="normal"><a href="#__codelineno-0-590">590</a></span>
<span class="normal"><a href="#__codelineno-0-591">591</a></span>
<span class="normal"><a href="#__codelineno-0-592">592</a></span>
<span class="normal"><a href="#__codelineno-0-593">593</a></span>
<span class="normal"><a href="#__codelineno-0-594">594</a></span>
<span class="normal"><a href="#__codelineno-0-595">595</a></span>
<span class="normal"><a href="#__codelineno-0-596">596</a></span>
<span class="normal"><a href="#__codelineno-0-597">597</a></span>
<span class="normal"><a href="#__codelineno-0-598">598</a></span>
<span class="normal"><a href="#__codelineno-0-599">599</a></span>
<span class="normal"><a href="#__codelineno-0-600">600</a></span>
<span class="normal"><a href="#__codelineno-0-601">601</a></span>
<span class="normal"><a href="#__codelineno-0-602">602</a></span>
<span class="normal"><a href="#__codelineno-0-603">603</a></span>
<span class="normal"><a href="#__codelineno-0-604">604</a></span>
<span class="normal"><a href="#__codelineno-0-605">605</a></span>
<span class="normal"><a href="#__codelineno-0-606">606</a></span>
<span class="normal"><a href="#__codelineno-0-607">607</a></span>
<span class="normal"><a href="#__codelineno-0-608">608</a></span>
<span class="normal"><a href="#__codelineno-0-609">609</a></span>
<span class="normal"><a href="#__codelineno-0-610">610</a></span>
<span class="normal"><a href="#__codelineno-0-611">611</a></span>
<span class="normal"><a href="#__codelineno-0-612">612</a></span>
<span class="normal"><a href="#__codelineno-0-613">613</a></span>
<span class="normal"><a href="#__codelineno-0-614">614</a></span>
<span class="normal"><a href="#__codelineno-0-615">615</a></span>
<span class="normal"><a href="#__codelineno-0-616">616</a></span>
<span class="normal"><a href="#__codelineno-0-617">617</a></span>
<span class="normal"><a href="#__codelineno-0-618">618</a></span>
<span class="normal"><a href="#__codelineno-0-619">619</a></span>
<span class="normal"><a href="#__codelineno-0-620">620</a></span>
<span class="normal"><a href="#__codelineno-0-621">621</a></span>
<span class="normal"><a href="#__codelineno-0-622">622</a></span>
<span class="normal"><a href="#__codelineno-0-623">623</a></span>
<span class="normal"><a href="#__codelineno-0-624">624</a></span>
<span class="normal"><a href="#__codelineno-0-625">625</a></span>
<span class="normal"><a href="#__codelineno-0-626">626</a></span>
<span class="normal"><a href="#__codelineno-0-627">627</a></span>
<span class="normal"><a href="#__codelineno-0-628">628</a></span>
<span class="normal"><a href="#__codelineno-0-629">629</a></span>
<span class="normal"><a href="#__codelineno-0-630">630</a></span>
<span class="normal"><a href="#__codelineno-0-631">631</a></span>
<span class="normal"><a href="#__codelineno-0-632">632</a></span>
<span class="normal"><a href="#__codelineno-0-633">633</a></span>
<span class="normal"><a href="#__codelineno-0-634">634</a></span>
<span class="normal"><a href="#__codelineno-0-635">635</a></span>
<span class="normal"><a href="#__codelineno-0-636">636</a></span>
<span class="normal"><a href="#__codelineno-0-637">637</a></span>
<span class="normal"><a href="#__codelineno-0-638">638</a></span>
<span class="normal"><a href="#__codelineno-0-639">639</a></span>
<span class="normal"><a href="#__codelineno-0-640">640</a></span>
<span class="normal"><a href="#__codelineno-0-641">641</a></span>
<span class="normal"><a href="#__codelineno-0-642">642</a></span>
<span class="normal"><a href="#__codelineno-0-643">643</a></span>
<span class="normal"><a href="#__codelineno-0-644">644</a></span>
<span class="normal"><a href="#__codelineno-0-645">645</a></span>
<span class="normal"><a href="#__codelineno-0-646">646</a></span>
<span class="normal"><a href="#__codelineno-0-647">647</a></span>
<span class="normal"><a href="#__codelineno-0-648">648</a></span>
<span class="normal"><a href="#__codelineno-0-649">649</a></span>
<span class="normal"><a href="#__codelineno-0-650">650</a></span>
<span class="normal"><a href="#__codelineno-0-651">651</a></span>
<span class="normal"><a href="#__codelineno-0-652">652</a></span>
<span class="normal"><a href="#__codelineno-0-653">653</a></span>
<span class="normal"><a href="#__codelineno-0-654">654</a></span>
<span class="normal"><a href="#__codelineno-0-655">655</a></span>
<span class="normal"><a href="#__codelineno-0-656">656</a></span>
<span class="normal"><a href="#__codelineno-0-657">657</a></span>
<span class="normal"><a href="#__codelineno-0-658">658</a></span>
<span class="normal"><a href="#__codelineno-0-659">659</a></span>
<span class="normal"><a href="#__codelineno-0-660">660</a></span>
<span class="normal"><a href="#__codelineno-0-661">661</a></span>
<span class="normal"><a href="#__codelineno-0-662">662</a></span>
<span class="normal"><a href="#__codelineno-0-663">663</a></span>
<span class="normal"><a href="#__codelineno-0-664">664</a></span>
<span class="normal"><a href="#__codelineno-0-665">665</a></span>
<span class="normal"><a href="#__codelineno-0-666">666</a></span>
<span class="normal"><a href="#__codelineno-0-667">667</a></span>
<span class="normal"><a href="#__codelineno-0-668">668</a></span>
<span class="normal"><a href="#__codelineno-0-669">669</a></span>
<span class="normal"><a href="#__codelineno-0-670">670</a></span>
<span class="normal"><a href="#__codelineno-0-671">671</a></span>
<span class="normal"><a href="#__codelineno-0-672">672</a></span>
<span class="normal"><a href="#__codelineno-0-673">673</a></span>
<span class="normal"><a href="#__codelineno-0-674">674</a></span>
<span class="normal"><a href="#__codelineno-0-675">675</a></span>
<span class="normal"><a href="#__codelineno-0-676">676</a></span>
<span class="normal"><a href="#__codelineno-0-677">677</a></span>
<span class="normal"><a href="#__codelineno-0-678">678</a></span>
<span class="normal"><a href="#__codelineno-0-679">679</a></span>
<span class="normal"><a href="#__codelineno-0-680">680</a></span>
<span class="normal"><a href="#__codelineno-0-681">681</a></span>
<span class="normal"><a href="#__codelineno-0-682">682</a></span>
<span class="normal"><a href="#__codelineno-0-683">683</a></span>
<span class="normal"><a href="#__codelineno-0-684">684</a></span>
<span class="normal"><a href="#__codelineno-0-685">685</a></span>
<span class="normal"><a href="#__codelineno-0-686">686</a></span>
<span class="normal"><a href="#__codelineno-0-687">687</a></span>
<span class="normal"><a href="#__codelineno-0-688">688</a></span>
<span class="normal"><a href="#__codelineno-0-689">689</a></span>
<span class="normal"><a href="#__codelineno-0-690">690</a></span>
<span class="normal"><a href="#__codelineno-0-691">691</a></span>
<span class="normal"><a href="#__codelineno-0-692">692</a></span>
<span class="normal"><a href="#__codelineno-0-693">693</a></span>
<span class="normal"><a href="#__codelineno-0-694">694</a></span>
<span class="normal"><a href="#__codelineno-0-695">695</a></span>
<span class="normal"><a href="#__codelineno-0-696">696</a></span>
<span class="normal"><a href="#__codelineno-0-697">697</a></span>
<span class="normal"><a href="#__codelineno-0-698">698</a></span>
<span class="normal"><a href="#__codelineno-0-699">699</a></span>
<span class="normal"><a href="#__codelineno-0-700">700</a></span>
<span class="normal"><a href="#__codelineno-0-701">701</a></span>
<span class="normal"><a href="#__codelineno-0-702">702</a></span>
<span class="normal"><a href="#__codelineno-0-703">703</a></span>
<span class="normal"><a href="#__codelineno-0-704">704</a></span>
<span class="normal"><a href="#__codelineno-0-705">705</a></span>
<span class="normal"><a href="#__codelineno-0-706">706</a></span>
<span class="normal"><a href="#__codelineno-0-707">707</a></span>
<span class="normal"><a href="#__codelineno-0-708">708</a></span>
<span class="normal"><a href="#__codelineno-0-709">709</a></span>
<span class="normal"><a href="#__codelineno-0-710">710</a></span>
<span class="normal"><a href="#__codelineno-0-711">711</a></span>
<span class="normal"><a href="#__codelineno-0-712">712</a></span>
<span class="normal"><a href="#__codelineno-0-713">713</a></span>
<span class="normal"><a href="#__codelineno-0-714">714</a></span>
<span class="normal"><a href="#__codelineno-0-715">715</a></span>
<span class="normal"><a href="#__codelineno-0-716">716</a></span>
<span class="normal"><a href="#__codelineno-0-717">717</a></span>
<span class="normal"><a href="#__codelineno-0-718">718</a></span>
<span class="normal"><a href="#__codelineno-0-719">719</a></span>
<span class="normal"><a href="#__codelineno-0-720">720</a></span>
<span class="normal"><a href="#__codelineno-0-721">721</a></span>
<span class="normal"><a href="#__codelineno-0-722">722</a></span>
<span class="normal"><a href="#__codelineno-0-723">723</a></span>
<span class="normal"><a href="#__codelineno-0-724">724</a></span>
<span class="normal"><a href="#__codelineno-0-725">725</a></span>
<span class="normal"><a href="#__codelineno-0-726">726</a></span>
<span class="normal"><a href="#__codelineno-0-727">727</a></span>
<span class="normal"><a href="#__codelineno-0-728">728</a></span>
<span class="normal"><a href="#__codelineno-0-729">729</a></span>
<span class="normal"><a href="#__codelineno-0-730">730</a></span>
<span class="normal"><a href="#__codelineno-0-731">731</a></span>
<span class="normal"><a href="#__codelineno-0-732">732</a></span>
<span class="normal"><a href="#__codelineno-0-733">733</a></span>
<span class="normal"><a href="#__codelineno-0-734">734</a></span>
<span class="normal"><a href="#__codelineno-0-735">735</a></span>
<span class="normal"><a href="#__codelineno-0-736">736</a></span>
<span class="normal"><a href="#__codelineno-0-737">737</a></span>
<span class="normal"><a href="#__codelineno-0-738">738</a></span>
<span class="normal"><a href="#__codelineno-0-739">739</a></span>
<span class="normal"><a href="#__codelineno-0-740">740</a></span>
<span class="normal"><a href="#__codelineno-0-741">741</a></span>
<span class="normal"><a href="#__codelineno-0-742">742</a></span>
<span class="normal"><a href="#__codelineno-0-743">743</a></span>
<span class="normal"><a href="#__codelineno-0-744">744</a></span>
<span class="normal"><a href="#__codelineno-0-745">745</a></span>
<span class="normal"><a href="#__codelineno-0-746">746</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-416" name="__codelineno-0-416"></a><span class="k">def</span><span class="w"> </span><span class="nf">export_bnode</span><span class="p">(</span><span class="n">cfg_export</span><span class="p">:</span> <span class="n">onnx_export_config_class</span><span class="p">):</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Main function for BNODE model export to ONNX format.</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a><span class="sd">    This function orchestrates the complete export process:</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a><span class="sd">    1. Loads trained BNODE model and configuration</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a><span class="sd">    2. Extracts individual encoder, decoder, and ODE components</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a><span class="sd">    3. Exports each component to ONNX format with dynamic batch dimensions</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a><span class="sd">    4. Saves example input/output data for validation</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a><span class="sd">    5. Exports configuration file for reference</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a><span class="sd">    The function is designed to be invoked via the ``uv run bnode_export`` command,</span>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a><span class="sd">    which is registered in ``pyproject.toml``. Hydra manages configuration loading</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a><span class="sd">    and command-line argument parsing.</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a><span class="sd">        cfg_export (onnx_export_config_class): Export configuration managed by Hydra.</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a><span class="sd">            Configuration can be specified via YAML files or command-line overrides.</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a><span class="sd">    Export Workflow:</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a><span class="sd">        1. **Model Loading**: </span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a><span class="sd">            - Retrieves model from MLflow or local directory</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a><span class="sd">            - Loads configuration and dataset for normalization</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a><span class="sd">            - Restores trained weights from checkpoint</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a><span class="sd">        2. **Component Extraction**:</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a><span class="sd">            - State encoder (always present)</span>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a><span class="sd">            - Control encoder (if model uses controls)</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a><span class="sd">            - Parameter encoder (if model uses parameters)</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a><span class="sd">            - Latent ODE function</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a><span class="sd">            - SSM parameter mapping (linear models only)</span>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a><span class="sd">            - Decoder (states and/or outputs)</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a><span class="sd">        3. **ONNX Export**:</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a><span class="sd">            - Each component is exported separately</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a><span class="sd">            - Dynamic batch dimensions allow flexible inference</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a><span class="sd">            - Input/output names are explicitly defined</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a><span class="sd">            - Example I/O saved for each component</span>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a><span class="sd">        4. **Artifact Organization**:</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a><span class="sd">            - All exports saved to output_dir or Hydra output</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a><span class="sd">            - Configuration exported as ``bnode_config.yaml``</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a><span class="sd">            - Example data in ``*_example_io.hdf5`` files</span>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a><span class="sd">    Command-Line Usage:</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a><span class="sd">        Export from MLflow::</span>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a><span class="sd">            uv run bnode_export mlflow_run_id=&lt;run_id&gt; \\</span>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a><span class="sd">                                mlflow_tracking_uri=&lt;uri&gt; \\</span>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a><span class="sd">                                output_dir=&lt;output_path&gt;</span>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a><span class="sd">        Export from local directory::</span>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a><span class="sd">            uv run bnode_export model_directory=&lt;path&gt; \\</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a><span class="sd">                                output_dir=&lt;output_path&gt;</span>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a><span class="sd">        With custom checkpoint::</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a><span class="sd">            uv run bnode_export mlflow_run_id=&lt;run_id&gt; \\</span>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a><span class="sd">                                model_checkpoint_path=&lt;checkpoint.pt&gt; \\</span>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a><span class="sd">                                dataset_path=&lt;dataset.hdf5&gt;</span>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a><span class="sd">    Exported Files:</span>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a><span class="sd">        - ``encoder_states.onnx``: State encoder</span>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a><span class="sd">        - ``encoder_controls.onnx``: Control encoder (if applicable)</span>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a><span class="sd">        - ``encoder_parameters.onnx``: Parameter encoder (if applicable)</span>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a><span class="sd">        - ``latent_ode.onnx``: Latent dynamics function</span>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a><span class="sd">        - ``latent_ode_ssm_from_param.onnx``: SSM mapping (linear models)</span>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a><span class="sd">        - ``decoder.onnx``: Decoder network</span>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a><span class="sd">        - ``encoder_*_example_io.hdf5``: Example encoder I/O</span>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a><span class="sd">        - ``latent_ode_example_io.hdf5``: Example ODE I/O</span>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a><span class="sd">        - ``decoder_example_io.hdf5``: Example decoder I/O</span>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a><span class="sd">        - ``bnode_config.yaml``: Complete model configuration</span>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a><span class="sd">    ONNX Model Specifications:</span>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a><span class="sd">        All exported models include:</span>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a><span class="sd">        - **Dynamic axes**: Batch dimension (axis 0) is dynamic</span>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a><span class="sd">        - **Input names**: Descriptive names for each input tensor</span>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a><span class="sd">        - **Output names**: Descriptive names for each output tensor</span>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a><span class="sd">        Encoder outputs:</span>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a><span class="sd">        - ``latent_&lt;type&gt;_mu``: Mean of latent distribution</span>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a><span class="sd">        - ``latent_&lt;type&gt;_logvar``: Log-variance of latent distribution</span>
<a id="__codelineno-0-501" name="__codelineno-0-501"></a>
<a id="__codelineno-0-502" name="__codelineno-0-502"></a><span class="sd">        ODE outputs:</span>
<a id="__codelineno-0-503" name="__codelineno-0-503"></a>
<a id="__codelineno-0-504" name="__codelineno-0-504"></a><span class="sd">        - ``lat_states_mu_dot``: State derivative (constant variance)</span>
<a id="__codelineno-0-505" name="__codelineno-0-505"></a><span class="sd">        - ``concat(lat_states_mu_dot,lat_states_logvar_dot)``: Combined</span>
<a id="__codelineno-0-506" name="__codelineno-0-506"></a><span class="sd">            derivatives (dynamic variance)</span>
<a id="__codelineno-0-507" name="__codelineno-0-507"></a>
<a id="__codelineno-0-508" name="__codelineno-0-508"></a><span class="sd">        Decoder outputs:</span>
<a id="__codelineno-0-509" name="__codelineno-0-509"></a>
<a id="__codelineno-0-510" name="__codelineno-0-510"></a><span class="sd">        - ``states``: Reconstructed physical states</span>
<a id="__codelineno-0-511" name="__codelineno-0-511"></a><span class="sd">        - ``outputs``: Reconstructed system outputs (if applicable)</span>
<a id="__codelineno-0-512" name="__codelineno-0-512"></a>
<a id="__codelineno-0-513" name="__codelineno-0-513"></a><span class="sd">    Notes:</span>
<a id="__codelineno-0-514" name="__codelineno-0-514"></a><span class="sd">        - Model is set to evaluation mode before export</span>
<a id="__codelineno-0-515" name="__codelineno-0-515"></a><span class="sd">        - All computations performed on CPU (use_cuda=False)</span>
<a id="__codelineno-0-516" name="__codelineno-0-516"></a><span class="sd">        - Normalization parameters are embedded in exported models</span>
<a id="__codelineno-0-517" name="__codelineno-0-517"></a><span class="sd">        - Example I/O files can be used to validate ONNX Runtime inference</span>
<a id="__codelineno-0-518" name="__codelineno-0-518"></a><span class="sd">        - Hydra output directory is used if output_dir not specified</span>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a>
<a id="__codelineno-0-520" name="__codelineno-0-520"></a><span class="sd">    See Also:</span>
<a id="__codelineno-0-521" name="__codelineno-0-521"></a><span class="sd">        - ``load_trained_latent_ode``: Model loading function</span>
<a id="__codelineno-0-522" name="__codelineno-0-522"></a><span class="sd">        - ``export_example_io_data``: Example I/O export function</span>
<a id="__codelineno-0-523" name="__codelineno-0-523"></a><span class="sd">        - ``bnode_core.ode.trainer.initialize_model``: Model initialization</span>
<a id="__codelineno-0-524" name="__codelineno-0-524"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-525" name="__codelineno-0-525"></a>    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Exporting BNODE using the following config </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cfg_export</span><span class="p">)))</span>
<a id="__codelineno-0-526" name="__codelineno-0-526"></a>
<a id="__codelineno-0-527" name="__codelineno-0-527"></a>    <span class="c1"># load model</span>
<a id="__codelineno-0-528" name="__codelineno-0-528"></a>    <span class="n">res</span> <span class="o">=</span> <span class="n">load_trained_latent_ode</span><span class="p">(</span><span class="n">cfg_export</span><span class="p">)</span>
<a id="__codelineno-0-529" name="__codelineno-0-529"></a>    <span class="n">model</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">dataset_file</span><span class="p">,</span> <span class="n">dataset</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;cfg&#39;</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;dataset_file&#39;</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;dataset&#39;</span><span class="p">]</span>
<a id="__codelineno-0-530" name="__codelineno-0-530"></a>    <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;temp_dir&#39;</span><span class="p">]</span>
<a id="__codelineno-0-531" name="__codelineno-0-531"></a>    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-0-532" name="__codelineno-0-532"></a>
<a id="__codelineno-0-533" name="__codelineno-0-533"></a>    <span class="c1"># determine output dir</span>
<a id="__codelineno-0-534" name="__codelineno-0-534"></a>    <span class="n">dir_output</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">cfg_export</span><span class="o">.</span><span class="n">output_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">cfg_export</span><span class="o">.</span><span class="n">output_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">filepaths</span><span class="o">.</span><span class="n">dir_current_hydra_output</span><span class="p">()</span>
<a id="__codelineno-0-535" name="__codelineno-0-535"></a>
<a id="__codelineno-0-536" name="__codelineno-0-536"></a>    <span class="c1"># export bnode config</span>
<a id="__codelineno-0-537" name="__codelineno-0-537"></a>    <span class="n">path_config</span> <span class="o">=</span> <span class="n">dir_output</span> <span class="o">/</span> <span class="s1">&#39;bnode_config.yaml&#39;</span>
<a id="__codelineno-0-538" name="__codelineno-0-538"></a>    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Exporting BNODE config to </span><span class="si">{</span><span class="n">path_config</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-539" name="__codelineno-0-539"></a>    <span class="n">path_config</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-540" name="__codelineno-0-540"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_config</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-0-541" name="__codelineno-0-541"></a>        <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">OmegaConf</span><span class="o">.</span><span class="n">to_container</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">resolve</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">f</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-542" name="__codelineno-0-542"></a>
<a id="__codelineno-0-543" name="__codelineno-0-543"></a>    <span class="c1"># get test points for graph construction</span>
<a id="__codelineno-0-544" name="__codelineno-0-544"></a>    <span class="n">test_state</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;states&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-545" name="__codelineno-0-545"></a>    <span class="n">test_control</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;controls&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">include_controls</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-0-546" name="__codelineno-0-546"></a>    <span class="n">test_parameters</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">include_parameters</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-0-547" name="__codelineno-0-547"></a>
<a id="__codelineno-0-548" name="__codelineno-0-548"></a>    <span class="c1"># export the encoders</span>
<a id="__codelineno-0-549" name="__codelineno-0-549"></a>    <span class="n">encoders</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;states&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">state_encoder</span><span class="p">,</span> 
<a id="__codelineno-0-550" name="__codelineno-0-550"></a>                <span class="s1">&#39;controls&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">controls_encoder</span> <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">include_controls</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-551" name="__codelineno-0-551"></a>                <span class="s1">&#39;parameters&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">parameter_encoder</span> <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">include_params_encoder</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-0-552" name="__codelineno-0-552"></a>            <span class="p">}</span>
<a id="__codelineno-0-553" name="__codelineno-0-553"></a>    <span class="c1"># construct test inputs for graph construction</span>
<a id="__codelineno-0-554" name="__codelineno-0-554"></a>    <span class="n">inputs_dict</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-555" name="__codelineno-0-555"></a>        <span class="s1">&#39;states&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">test_state</span><span class="p">},</span>
<a id="__codelineno-0-556" name="__codelineno-0-556"></a>        <span class="s1">&#39;controls&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">test_control</span><span class="p">}</span> <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">params_to_control_encoder</span> <span class="ow">is</span> <span class="kc">False</span> <span class="k">else</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">test_control</span><span class="p">,</span> <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="n">test_parameters</span><span class="p">},</span>
<a id="__codelineno-0-557" name="__codelineno-0-557"></a>        <span class="s1">&#39;parameters&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">test_parameters</span><span class="p">},</span>
<a id="__codelineno-0-558" name="__codelineno-0-558"></a>    <span class="p">}</span>
<a id="__codelineno-0-559" name="__codelineno-0-559"></a>    <span class="c1"># handling of additional inputs to state encoder</span>
<a id="__codelineno-0-560" name="__codelineno-0-560"></a>    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">params_to_state_encoder</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-0-561" name="__codelineno-0-561"></a>        <span class="n">inputs_dict</span><span class="p">[</span><span class="s1">&#39;states&#39;</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_parameters</span>
<a id="__codelineno-0-562" name="__codelineno-0-562"></a>    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">controls_to_state_encoder</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-0-563" name="__codelineno-0-563"></a>        <span class="n">inputs_dict</span><span class="p">[</span><span class="s1">&#39;states&#39;</span><span class="p">][</span><span class="s1">&#39;controls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_control</span>
<a id="__codelineno-0-564" name="__codelineno-0-564"></a>
<a id="__codelineno-0-565" name="__codelineno-0-565"></a>    <span class="n">latents_dict</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-566" name="__codelineno-0-566"></a>    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">encoder</span> <span class="ow">in</span> <span class="n">encoders</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-567" name="__codelineno-0-567"></a>        <span class="k">if</span> <span class="n">encoder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-568" name="__codelineno-0-568"></a>            <span class="n">path_encoder</span> <span class="o">=</span> <span class="n">dir_output</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;encoder_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">.onnx&#39;</span>
<a id="__codelineno-0-569" name="__codelineno-0-569"></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Exporting </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1"> encoder to </span><span class="si">{</span><span class="n">path_encoder</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-570" name="__codelineno-0-570"></a>            <span class="c1"># test model</span>
<a id="__codelineno-0-571" name="__codelineno-0-571"></a>            <span class="n">log_shapes_of_dict</span><span class="p">(</span><span class="n">inputs_dict</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="sa">f</span><span class="s1">&#39;Inputs for </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1"> encoder&#39;</span><span class="p">)</span>
<a id="__codelineno-0-572" name="__codelineno-0-572"></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">encoder</span><span class="p">(</span><span class="o">**</span><span class="n">inputs_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
<a id="__codelineno-0-573" name="__codelineno-0-573"></a>            <span class="n">log_shapes_of_dict</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Outputs of </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1"> encoder&#39;</span><span class="p">)</span>
<a id="__codelineno-0-574" name="__codelineno-0-574"></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Test result </span><span class="si">{</span><span class="n">res</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-575" name="__codelineno-0-575"></a>            <span class="c1"># export</span>
<a id="__codelineno-0-576" name="__codelineno-0-576"></a>            <span class="n">input_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">inputs_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<a id="__codelineno-0-577" name="__codelineno-0-577"></a>            <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;latent_&#39;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;_mu&#39;</span><span class="p">,</span> <span class="s1">&#39;latent_&#39;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;_logvar&#39;</span><span class="p">]</span>
<a id="__codelineno-0-578" name="__codelineno-0-578"></a>            <span class="n">dynamic_axes</span><span class="o">=</span><span class="p">{}</span>
<a id="__codelineno-0-579" name="__codelineno-0-579"></a>            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">input_names</span><span class="p">:</span>
<a id="__codelineno-0-580" name="__codelineno-0-580"></a>                <span class="n">dynamic_axes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;batch_size&#39;</span><span class="p">}</span>
<a id="__codelineno-0-581" name="__codelineno-0-581"></a>            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">output_names</span><span class="p">:</span>
<a id="__codelineno-0-582" name="__codelineno-0-582"></a>                <span class="n">dynamic_axes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;batch_size&#39;</span><span class="p">}</span>
<a id="__codelineno-0-583" name="__codelineno-0-583"></a>            <span class="c1"># Use legacy TorchScript-based exporter for better stability</span>
<a id="__codelineno-0-584" name="__codelineno-0-584"></a>            <span class="n">torch</span><span class="o">.</span><span class="n">onnx</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> 
<a id="__codelineno-0-585" name="__codelineno-0-585"></a>                              <span class="n">args</span><span class="o">=</span><span class="p">(),</span>
<a id="__codelineno-0-586" name="__codelineno-0-586"></a>                              <span class="n">kwargs</span><span class="o">=</span><span class="n">inputs_dict</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
<a id="__codelineno-0-587" name="__codelineno-0-587"></a>                              <span class="n">f</span><span class="o">=</span><span class="n">path_encoder</span><span class="p">,</span> 
<a id="__codelineno-0-588" name="__codelineno-0-588"></a>                              <span class="n">input_names</span><span class="o">=</span><span class="n">input_names</span><span class="p">,</span>
<a id="__codelineno-0-589" name="__codelineno-0-589"></a>                              <span class="n">output_names</span><span class="o">=</span><span class="n">output_names</span><span class="p">,</span>
<a id="__codelineno-0-590" name="__codelineno-0-590"></a>                              <span class="n">dynamic_axes</span><span class="o">=</span><span class="n">dynamic_axes</span><span class="p">,</span>
<a id="__codelineno-0-591" name="__codelineno-0-591"></a>                              <span class="n">dynamo</span><span class="o">=</span><span class="kc">False</span>
<a id="__codelineno-0-592" name="__codelineno-0-592"></a>            <span class="p">)</span>
<a id="__codelineno-0-593" name="__codelineno-0-593"></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Exported </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1"> encoder successfully&#39;</span><span class="p">)</span>
<a id="__codelineno-0-594" name="__codelineno-0-594"></a>            <span class="c1"># export also example io</span>
<a id="__codelineno-0-595" name="__codelineno-0-595"></a>            <span class="n">path_example_io</span> <span class="o">=</span> <span class="n">dir_output</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;encoder_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">_example_io.hdf5&#39;</span>
<a id="__codelineno-0-596" name="__codelineno-0-596"></a>            <span class="n">export_example_io_data</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">inputs_dict</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">path_example_io</span><span class="p">)</span>
<a id="__codelineno-0-597" name="__codelineno-0-597"></a>            <span class="c1"># save latent variable</span>
<a id="__codelineno-0-598" name="__codelineno-0-598"></a>            <span class="n">latents_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># the first is mu</span>
<a id="__codelineno-0-599" name="__codelineno-0-599"></a>
<a id="__codelineno-0-600" name="__codelineno-0-600"></a>    <span class="c1"># export ssm from parameters model and get A_from_param and B_from_param for the latent ODE function</span>
<a id="__codelineno-0-601" name="__codelineno-0-601"></a>    <span class="n">ode</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">latent_ode_func</span>
<a id="__codelineno-0-602" name="__codelineno-0-602"></a>    <span class="k">if</span> <span class="n">ode</span><span class="o">.</span><span class="n">include_parameters</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">ode</span><span class="o">.</span><span class="n">linear</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-0-603" name="__codelineno-0-603"></a>        <span class="c1"># this is only possible if the model is linear and has parameters</span>
<a id="__codelineno-0-604" name="__codelineno-0-604"></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Exporting SSM from parameters&#39;</span><span class="p">)</span>
<a id="__codelineno-0-605" name="__codelineno-0-605"></a>        <span class="n">ssm</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">latent_ode_func</span><span class="o">.</span><span class="n">ssm_from_param</span>
<a id="__codelineno-0-606" name="__codelineno-0-606"></a>        <span class="n">path_ssm</span> <span class="o">=</span> <span class="n">dir_output</span> <span class="o">/</span> <span class="s1">&#39;latent_ode_ssm_from_param.onnx&#39;</span>
<a id="__codelineno-0-607" name="__codelineno-0-607"></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Export latent ODE SSM from parameters to </span><span class="si">{</span><span class="n">path_ssm</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-608" name="__codelineno-0-608"></a>        <span class="c1"># construct test input</span>
<a id="__codelineno-0-609" name="__codelineno-0-609"></a>        <span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-610" name="__codelineno-0-610"></a>            <span class="s1">&#39;lat_parameters&#39;</span><span class="p">:</span> <span class="n">latents_dict</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">],</span>
<a id="__codelineno-0-611" name="__codelineno-0-611"></a>        <span class="p">}</span>
<a id="__codelineno-0-612" name="__codelineno-0-612"></a>        <span class="c1"># test model</span>
<a id="__codelineno-0-613" name="__codelineno-0-613"></a>        <span class="n">log_shapes_of_dict</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="s1">&#39;Inputs for latent ODE SSM from parameters&#39;</span><span class="p">)</span>
<a id="__codelineno-0-614" name="__codelineno-0-614"></a>        <span class="n">res</span> <span class="o">=</span> <span class="n">ssm</span><span class="p">(</span><span class="o">**</span><span class="n">inputs</span><span class="p">)</span>
<a id="__codelineno-0-615" name="__codelineno-0-615"></a>        <span class="n">log_shapes_of_dict</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="s1">&#39;Outputs of latent ODE SSM from parameters&#39;</span><span class="p">)</span>
<a id="__codelineno-0-616" name="__codelineno-0-616"></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Test result </span><span class="si">{</span><span class="n">res</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-617" name="__codelineno-0-617"></a>        <span class="c1"># export</span>
<a id="__codelineno-0-618" name="__codelineno-0-618"></a>        <span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;lat_parameters&#39;</span><span class="p">]</span>
<a id="__codelineno-0-619" name="__codelineno-0-619"></a>        <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">ode</span><span class="o">.</span><span class="n">include_controls</span> <span class="k">else</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span>
<a id="__codelineno-0-620" name="__codelineno-0-620"></a>        <span class="n">dynamic_axes</span><span class="o">=</span><span class="p">{}</span>
<a id="__codelineno-0-621" name="__codelineno-0-621"></a>        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">input_names</span><span class="p">:</span>
<a id="__codelineno-0-622" name="__codelineno-0-622"></a>            <span class="n">dynamic_axes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;batch_size&#39;</span><span class="p">}</span>
<a id="__codelineno-0-623" name="__codelineno-0-623"></a>        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">output_names</span><span class="p">:</span>
<a id="__codelineno-0-624" name="__codelineno-0-624"></a>            <span class="n">dynamic_axes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;batch_size&#39;</span><span class="p">}</span>
<a id="__codelineno-0-625" name="__codelineno-0-625"></a>        <span class="n">torch</span><span class="o">.</span><span class="n">onnx</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">ssm</span><span class="p">,</span> 
<a id="__codelineno-0-626" name="__codelineno-0-626"></a>                          <span class="n">args</span><span class="o">=</span><span class="p">(),</span>
<a id="__codelineno-0-627" name="__codelineno-0-627"></a>                          <span class="n">kwargs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span>
<a id="__codelineno-0-628" name="__codelineno-0-628"></a>                          <span class="n">f</span><span class="o">=</span><span class="n">path_ssm</span><span class="p">,</span> 
<a id="__codelineno-0-629" name="__codelineno-0-629"></a>                          <span class="n">input_names</span><span class="o">=</span><span class="n">input_names</span><span class="p">,</span> 
<a id="__codelineno-0-630" name="__codelineno-0-630"></a>                          <span class="n">output_names</span><span class="o">=</span><span class="n">output_names</span><span class="p">,</span> 
<a id="__codelineno-0-631" name="__codelineno-0-631"></a>                          <span class="n">dynamic_axes</span><span class="o">=</span><span class="n">dynamic_axes</span><span class="p">,</span>
<a id="__codelineno-0-632" name="__codelineno-0-632"></a>                          <span class="n">dynamo</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-633" name="__codelineno-0-633"></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Exported latent ODE SSM from parameters successfully&#39;</span><span class="p">)</span>
<a id="__codelineno-0-634" name="__codelineno-0-634"></a>        <span class="c1"># get A_from_param and B_from_param</span>
<a id="__codelineno-0-635" name="__codelineno-0-635"></a>        <span class="k">if</span> <span class="n">ode</span><span class="o">.</span><span class="n">include_controls</span><span class="p">:</span>
<a id="__codelineno-0-636" name="__codelineno-0-636"></a>            <span class="n">A_from_param</span><span class="p">,</span> <span class="n">B_from_param</span> <span class="o">=</span> <span class="n">res</span>
<a id="__codelineno-0-637" name="__codelineno-0-637"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-638" name="__codelineno-0-638"></a>            <span class="n">A_from_param</span> <span class="o">=</span> <span class="n">res</span>
<a id="__codelineno-0-639" name="__codelineno-0-639"></a>
<a id="__codelineno-0-640" name="__codelineno-0-640"></a>    <span class="c1"># export the latent ode function</span>
<a id="__codelineno-0-641" name="__codelineno-0-641"></a>    <span class="n">path_ode</span> <span class="o">=</span> <span class="n">dir_output</span> <span class="o">/</span> <span class="s1">&#39;latent_ode.onnx&#39;</span>
<a id="__codelineno-0-642" name="__codelineno-0-642"></a>    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Export latent ODE to </span><span class="si">{</span><span class="n">path_ode</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-643" name="__codelineno-0-643"></a>    <span class="c1"># construct test input</span>
<a id="__codelineno-0-644" name="__codelineno-0-644"></a>    <span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-645" name="__codelineno-0-645"></a>        <span class="s1">&#39;lat_states&#39;</span><span class="p">:</span> <span class="n">latents_dict</span><span class="p">[</span><span class="s1">&#39;states&#39;</span><span class="p">],</span>
<a id="__codelineno-0-646" name="__codelineno-0-646"></a>        <span class="s1">&#39;lat_parameters&#39;</span><span class="p">:</span> <span class="n">latents_dict</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">ode</span><span class="o">.</span><span class="n">include_parameters</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-647" name="__codelineno-0-647"></a>        <span class="s1">&#39;lat_controls&#39;</span><span class="p">:</span> <span class="n">latents_dict</span><span class="p">[</span><span class="s1">&#39;controls&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">ode</span><span class="o">.</span><span class="n">include_controls</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-648" name="__codelineno-0-648"></a>        <span class="s1">&#39;A_from_param&#39;</span><span class="p">:</span> <span class="n">A_from_param</span> <span class="k">if</span> <span class="n">ode</span><span class="o">.</span><span class="n">include_parameters</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">ode</span><span class="o">.</span><span class="n">linear</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-649" name="__codelineno-0-649"></a>        <span class="s1">&#39;B_from_param&#39;</span><span class="p">:</span> <span class="n">B_from_param</span> <span class="k">if</span> <span class="n">ode</span><span class="o">.</span><span class="n">include_parameters</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">ode</span><span class="o">.</span><span class="n">linear</span> <span class="ow">and</span> <span class="n">ode</span><span class="o">.</span><span class="n">include_controls</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-650" name="__codelineno-0-650"></a>    <span class="p">}</span>
<a id="__codelineno-0-651" name="__codelineno-0-651"></a>    <span class="c1"># test model</span>
<a id="__codelineno-0-652" name="__codelineno-0-652"></a>    <span class="n">log_shapes_of_dict</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="s1">&#39;Inputs for latent ODE&#39;</span><span class="p">)</span>
<a id="__codelineno-0-653" name="__codelineno-0-653"></a>    <span class="n">res</span> <span class="o">=</span> <span class="n">ode</span><span class="p">(</span><span class="o">**</span><span class="n">inputs</span><span class="p">)</span>
<a id="__codelineno-0-654" name="__codelineno-0-654"></a>    <span class="n">log_shapes_of_dict</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="s1">&#39;Outputs of latent ODE&#39;</span><span class="p">)</span>
<a id="__codelineno-0-655" name="__codelineno-0-655"></a>    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Test result </span><span class="si">{</span><span class="n">res</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-656" name="__codelineno-0-656"></a>    <span class="c1"># export</span>
<a id="__codelineno-0-657" name="__codelineno-0-657"></a>    <span class="n">input_names</span><span class="o">=</span><span class="p">[]</span>
<a id="__codelineno-0-658" name="__codelineno-0-658"></a>    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-0-659" name="__codelineno-0-659"></a>        <span class="k">if</span> <span class="n">inputs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-660" name="__codelineno-0-660"></a>            <span class="n">input_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<a id="__codelineno-0-661" name="__codelineno-0-661"></a>    <span class="n">dynamic_axes</span><span class="o">=</span><span class="p">{}</span>
<a id="__codelineno-0-662" name="__codelineno-0-662"></a>    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">input_names</span><span class="p">:</span>
<a id="__codelineno-0-663" name="__codelineno-0-663"></a>        <span class="n">dynamic_axes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;batch_size&#39;</span><span class="p">}</span>
<a id="__codelineno-0-664" name="__codelineno-0-664"></a>    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">lat_ode_type</span> <span class="o">==</span> <span class="s1">&#39;variance_constant&#39;</span> <span class="ow">or</span> <span class="n">model</span><span class="o">.</span><span class="n">lat_ode_type</span> <span class="o">==</span> <span class="s1">&#39;vanilla&#39;</span><span class="p">:</span>
<a id="__codelineno-0-665" name="__codelineno-0-665"></a>        <span class="n">output_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;lat_states_mu_dot&#39;</span><span class="p">]</span>
<a id="__codelineno-0-666" name="__codelineno-0-666"></a>        <span class="n">dynamic_axes</span><span class="p">[</span><span class="s1">&#39;lat_states_mu_dot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;batch_size&#39;</span><span class="p">}</span>
<a id="__codelineno-0-667" name="__codelineno-0-667"></a>    <span class="k">elif</span> <span class="n">model</span><span class="o">.</span><span class="n">lat_ode_type</span> <span class="o">==</span> <span class="s1">&#39;variance_dynamic&#39;</span><span class="p">:</span>
<a id="__codelineno-0-668" name="__codelineno-0-668"></a>        <span class="n">output_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;concat(lat_states_mu_dot,lat_states_logvar_dot)&#39;</span><span class="p">]</span>
<a id="__codelineno-0-669" name="__codelineno-0-669"></a>        <span class="n">dynamic_axes</span><span class="p">[</span><span class="s1">&#39;concat(lat_states_mu_dot,lat_states_logvar_dot)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;batch_size&#39;</span><span class="p">}</span>
<a id="__codelineno-0-670" name="__codelineno-0-670"></a>    <span class="c1"># Filter out None values and convert to tuple</span>
<a id="__codelineno-0-671" name="__codelineno-0-671"></a>    <span class="n">filtered_inputs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>
<a id="__codelineno-0-672" name="__codelineno-0-672"></a>    <span class="n">torch</span><span class="o">.</span><span class="n">onnx</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">ode</span><span class="p">,</span> 
<a id="__codelineno-0-673" name="__codelineno-0-673"></a>                      <span class="n">args</span><span class="o">=</span><span class="p">(),</span>
<a id="__codelineno-0-674" name="__codelineno-0-674"></a>                      <span class="n">kwargs</span><span class="o">=</span><span class="n">filtered_inputs</span><span class="p">,</span>
<a id="__codelineno-0-675" name="__codelineno-0-675"></a>                      <span class="n">f</span><span class="o">=</span><span class="n">path_ode</span><span class="p">,</span> 
<a id="__codelineno-0-676" name="__codelineno-0-676"></a>                      <span class="n">input_names</span><span class="o">=</span><span class="n">input_names</span><span class="p">,</span> 
<a id="__codelineno-0-677" name="__codelineno-0-677"></a>                      <span class="n">output_names</span><span class="o">=</span><span class="n">output_names</span><span class="p">,</span> 
<a id="__codelineno-0-678" name="__codelineno-0-678"></a>                      <span class="n">dynamic_axes</span><span class="o">=</span><span class="n">dynamic_axes</span><span class="p">,</span>
<a id="__codelineno-0-679" name="__codelineno-0-679"></a>                      <span class="n">dynamo</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-680" name="__codelineno-0-680"></a>    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Exported latent ODE successfully&#39;</span><span class="p">)</span>
<a id="__codelineno-0-681" name="__codelineno-0-681"></a>    <span class="c1"># export also example io</span>
<a id="__codelineno-0-682" name="__codelineno-0-682"></a>    <span class="n">path_example_io</span> <span class="o">=</span> <span class="n">dir_output</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;latent_ode_example_io.hdf5&#39;</span>
<a id="__codelineno-0-683" name="__codelineno-0-683"></a>    <span class="n">export_example_io_data</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">path_example_io</span><span class="p">)</span>
<a id="__codelineno-0-684" name="__codelineno-0-684"></a>
<a id="__codelineno-0-685" name="__codelineno-0-685"></a>    <span class="c1"># export the decoder</span>
<a id="__codelineno-0-686" name="__codelineno-0-686"></a>    <span class="c1"># TODO: What to with split return? because we have to tak the first n elements for states etc now... implement other function for this? / optional argument?</span>
<a id="__codelineno-0-687" name="__codelineno-0-687"></a>    <span class="n">decoder</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">decoder</span>
<a id="__codelineno-0-688" name="__codelineno-0-688"></a>    <span class="n">decoder</span><span class="o">.</span><span class="n">onnx_export</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># disable concatenation of outputs for ONNX export</span>
<a id="__codelineno-0-689" name="__codelineno-0-689"></a>    <span class="n">path_decoder</span> <span class="o">=</span> <span class="n">dir_output</span> <span class="o">/</span> <span class="s1">&#39;decoder.onnx&#39;</span>
<a id="__codelineno-0-690" name="__codelineno-0-690"></a>    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Export decoder to </span><span class="si">{</span><span class="n">path_decoder</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-691" name="__codelineno-0-691"></a>    <span class="c1"># construct test input</span>
<a id="__codelineno-0-692" name="__codelineno-0-692"></a>    <span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-693" name="__codelineno-0-693"></a>        <span class="s1">&#39;lat_state&#39;</span><span class="p">:</span> <span class="n">latents_dict</span><span class="p">[</span><span class="s1">&#39;states&#39;</span><span class="p">],</span>
<a id="__codelineno-0-694" name="__codelineno-0-694"></a>        <span class="s1">&#39;lat_parameters&#39;</span><span class="p">:</span> <span class="n">latents_dict</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">decoder</span><span class="o">.</span><span class="n">include_parameters</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-695" name="__codelineno-0-695"></a>        <span class="s1">&#39;lat_controls&#39;</span><span class="p">:</span> <span class="n">latents_dict</span><span class="p">[</span><span class="s1">&#39;controls&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">decoder</span><span class="o">.</span><span class="n">include_controls</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-696" name="__codelineno-0-696"></a>    <span class="p">}</span>
<a id="__codelineno-0-697" name="__codelineno-0-697"></a>    <span class="c1"># test model</span>
<a id="__codelineno-0-698" name="__codelineno-0-698"></a>    <span class="n">log_shapes_of_dict</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="s1">&#39;Inputs for decoder&#39;</span><span class="p">)</span>
<a id="__codelineno-0-699" name="__codelineno-0-699"></a>    <span class="n">res</span> <span class="o">=</span> <span class="n">decoder</span><span class="p">(</span><span class="o">**</span><span class="n">inputs</span><span class="p">)</span>
<a id="__codelineno-0-700" name="__codelineno-0-700"></a>    <span class="n">log_shapes_of_dict</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="s1">&#39;Outputs of decoder&#39;</span><span class="p">)</span>
<a id="__codelineno-0-701" name="__codelineno-0-701"></a>    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Test result </span><span class="si">{</span><span class="n">res</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-702" name="__codelineno-0-702"></a>    <span class="n">input_names</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-703" name="__codelineno-0-703"></a>    <span class="c1"># export</span>
<a id="__codelineno-0-704" name="__codelineno-0-704"></a>    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-0-705" name="__codelineno-0-705"></a>        <span class="k">if</span> <span class="n">inputs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-706" name="__codelineno-0-706"></a>            <span class="n">input_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<a id="__codelineno-0-707" name="__codelineno-0-707"></a>    <span class="k">if</span> <span class="n">decoder</span><span class="o">.</span><span class="n">include_outputs</span> <span class="ow">and</span> <span class="n">decoder</span><span class="o">.</span><span class="n">include_states</span><span class="p">:</span>
<a id="__codelineno-0-708" name="__codelineno-0-708"></a>        <span class="n">output_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;states&#39;</span><span class="p">,</span> <span class="s1">&#39;outputs&#39;</span><span class="p">]</span>
<a id="__codelineno-0-709" name="__codelineno-0-709"></a>    <span class="k">elif</span> <span class="n">decoder</span><span class="o">.</span><span class="n">include_outputs</span><span class="p">:</span>
<a id="__codelineno-0-710" name="__codelineno-0-710"></a>        <span class="n">output_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;outputs&#39;</span><span class="p">]</span>
<a id="__codelineno-0-711" name="__codelineno-0-711"></a>    <span class="k">elif</span> <span class="n">decoder</span><span class="o">.</span><span class="n">include_states</span><span class="p">:</span>
<a id="__codelineno-0-712" name="__codelineno-0-712"></a>        <span class="n">output_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;states&#39;</span><span class="p">]</span>
<a id="__codelineno-0-713" name="__codelineno-0-713"></a>    <span class="n">dynamic_axes</span><span class="o">=</span><span class="p">{}</span>
<a id="__codelineno-0-714" name="__codelineno-0-714"></a>    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">input_names</span><span class="p">:</span>
<a id="__codelineno-0-715" name="__codelineno-0-715"></a>        <span class="n">dynamic_axes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;batch_size&#39;</span><span class="p">}</span>
<a id="__codelineno-0-716" name="__codelineno-0-716"></a>    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">output_names</span><span class="p">:</span>
<a id="__codelineno-0-717" name="__codelineno-0-717"></a>        <span class="n">dynamic_axes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;batch_size&#39;</span><span class="p">}</span>
<a id="__codelineno-0-718" name="__codelineno-0-718"></a>    <span class="c1"># Filter out None values and convert to tuple</span>
<a id="__codelineno-0-719" name="__codelineno-0-719"></a>    <span class="n">filtered_inputs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>
<a id="__codelineno-0-720" name="__codelineno-0-720"></a>    <span class="n">torch</span><span class="o">.</span><span class="n">onnx</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">decoder</span><span class="p">,</span> 
<a id="__codelineno-0-721" name="__codelineno-0-721"></a>                      <span class="n">args</span><span class="o">=</span><span class="p">(),</span>
<a id="__codelineno-0-722" name="__codelineno-0-722"></a>                      <span class="n">kwargs</span><span class="o">=</span><span class="n">filtered_inputs</span><span class="p">,</span>
<a id="__codelineno-0-723" name="__codelineno-0-723"></a>                      <span class="n">f</span><span class="o">=</span><span class="n">path_decoder</span><span class="p">,</span> 
<a id="__codelineno-0-724" name="__codelineno-0-724"></a>                      <span class="n">input_names</span><span class="o">=</span><span class="n">input_names</span><span class="p">,</span> 
<a id="__codelineno-0-725" name="__codelineno-0-725"></a>                      <span class="n">output_names</span><span class="o">=</span><span class="n">output_names</span><span class="p">,</span> 
<a id="__codelineno-0-726" name="__codelineno-0-726"></a>                      <span class="n">dynamic_axes</span><span class="o">=</span><span class="n">dynamic_axes</span><span class="p">,</span>
<a id="__codelineno-0-727" name="__codelineno-0-727"></a>                      <span class="n">dynamo</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-728" name="__codelineno-0-728"></a>    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Exported decoder successfully&#39;</span><span class="p">)</span>
<a id="__codelineno-0-729" name="__codelineno-0-729"></a>    <span class="c1"># export also example io</span>
<a id="__codelineno-0-730" name="__codelineno-0-730"></a>    <span class="n">path_example_io</span> <span class="o">=</span> <span class="n">dir_output</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;decoder_example_io.hdf5&#39;</span>
<a id="__codelineno-0-731" name="__codelineno-0-731"></a>    <span class="n">export_example_io_data</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">path_example_io</span><span class="p">)</span>
<a id="__codelineno-0-732" name="__codelineno-0-732"></a>
<a id="__codelineno-0-733" name="__codelineno-0-733"></a>    <span class="k">if</span> <span class="n">temp_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-734" name="__codelineno-0-734"></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cleaning up temporary directory: </span><span class="si">{</span><span class="n">temp_dir</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-735" name="__codelineno-0-735"></a>        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-736" name="__codelineno-0-736"></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Temporary directory cleaned up successfully&#39;</span><span class="p">)</span>
<a id="__codelineno-0-737" name="__codelineno-0-737"></a>
<a id="__codelineno-0-738" name="__codelineno-0-738"></a>    <span class="c1"># copy the current hydra folder to the output for reference</span>
<a id="__codelineno-0-739" name="__codelineno-0-739"></a>    <span class="n">dir_hydra_current</span> <span class="o">=</span> <span class="n">filepaths</span><span class="o">.</span><span class="n">dir_current_hydra_output</span><span class="p">()</span>
<a id="__codelineno-0-740" name="__codelineno-0-740"></a>    <span class="n">dir_hydra_output_copy</span> <span class="o">=</span> <span class="n">dir_output</span> <span class="o">/</span> <span class="s1">&#39;hydra&#39;</span>
<a id="__codelineno-0-741" name="__codelineno-0-741"></a>    <span class="k">if</span> <span class="n">dir_hydra_current</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="n">dir_hydra_output_copy</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span> <span class="o">!=</span> <span class="n">dir_hydra_current</span><span class="o">.</span><span class="n">absolute</span><span class="p">()):</span>
<a id="__codelineno-0-742" name="__codelineno-0-742"></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Copying current Hydra directory </span><span class="si">{</span><span class="n">dir_hydra_current</span><span class="si">}</span><span class="s1"> to output </span><span class="si">{</span><span class="n">dir_hydra_output_copy</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-743" name="__codelineno-0-743"></a>        <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">dir_hydra_current</span><span class="p">,</span> <span class="n">dir_hydra_output_copy</span><span class="p">,</span> <span class="n">dirs_exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-744" name="__codelineno-0-744"></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Hydra directory copied successfully&#39;</span><span class="p">)</span>
<a id="__codelineno-0-745" name="__codelineno-0-745"></a>    <span class="k">else</span><span class="p">:</span> 
<a id="__codelineno-0-746" name="__codelineno-0-746"></a>       <span class="ne">Warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Current Hydra directory </span><span class="si">{</span><span class="n">dir_hydra_current</span><span class="si">}</span><span class="s1"> not found and could not be copied.&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://www.uni-augsburg.de/de/fakultaet/fai/informatik/prof/imech/team/julius-aka/" target="_blank" rel="noopener" title="www.uni-augsburg.de" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.36 14c.08-.66.14-1.32.14-2s-.06-1.34-.14-2h3.38c.16.64.26 1.31.26 2s-.1 1.36-.26 2m-5.15 5.56c.6-1.11 1.06-2.31 1.38-3.56h2.95a8.03 8.03 0 0 1-4.33 3.56M14.34 14H9.66c-.1-.66-.16-1.32-.16-2s.06-1.35.16-2h4.68c.09.65.16 1.32.16 2s-.07 1.34-.16 2M12 19.96c-.83-1.2-1.5-2.53-1.91-3.96h3.82c-.41 1.43-1.08 2.76-1.91 3.96M8 8H5.08A7.92 7.92 0 0 1 9.4 4.44C8.8 5.55 8.35 6.75 8 8m-2.92 8H8c.35 1.25.8 2.45 1.4 3.56A8 8 0 0 1 5.08 16m-.82-2C4.1 13.36 4 12.69 4 12s.1-1.36.26-2h3.38c-.08.66-.14 1.32-.14 2s.06 1.34.14 2M12 4.03c.83 1.2 1.5 2.54 1.91 3.97h-3.82c.41-1.43 1.08-2.77 1.91-3.97M18.92 8h-2.95a15.7 15.7 0 0 0-1.38-3.56c1.84.63 3.37 1.9 4.33 3.56M12 2C6.47 2 2 6.5 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10A10 10 0 0 0 12 2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.linkedin.com/in/julius-aka/" target="_blank" rel="noopener" title="www.linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2zm-.5 15.5v-5.3a3.26 3.26 0 0 0-3.26-3.26c-.85 0-1.84.52-2.32 1.3v-1.11h-2.79v8.37h2.79v-4.93c0-.77.62-1.4 1.39-1.4a1.4 1.4 0 0 1 1.4 1.4v4.93zM6.88 8.56a1.68 1.68 0 0 0 1.68-1.68c0-.93-.75-1.69-1.68-1.69a1.69 1.69 0 0 0-1.69 1.69c0 .93.76 1.68 1.69 1.68m1.39 9.94v-8.37H5.5v8.37z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://scholar.google.com/citations?user=7SypqSQAAAAJ&hl" target="_blank" rel="noopener" title="scholar.google.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 3 1 9l11 6 9-4.91V17h2V9M5 13.18v4L12 21l7-3.82v-4L12 17z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://github.com/juliusaka" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../../..", "features": ["navigation.instant", "navigation.top", "navigation.tabs", "search.suggest", "search.highlight"], "search": "../../../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
    
  </body>
</html>